---
- block:
  - name: Add the OS specific varibles
    include_vars: "{{ ansible_os_family }}.yml"

  # - name: Install the openldap and required Packages for RedHat
  #   yum: name={{ item }} state=present
  #   with_items: openldap_server_pkgs
  #   when: ansible_os_family == 'RedHat'

  - name: Install the openldap and required Packages for Ubuntu
    package: 
      name: "{{ item }}"
      state: present 
    with_items: "{{ openldap_server_pkgs }}"
    # environment: env
    # when: ansible_os_family == 'Debian'

  - name: Delete the configuration directory
    file: 
      path: "{{ openldap_server_app_path }}/slapd.d"
      state: absent

  - name: Decide on random root password
    set_fact:
      openldap_server_random_rootpw: "{{ openldap_server_rootpw }}"

# WARNING: THIS PRINTS THE MANAGER PASSWORD DURING INSTALLATION, ONLY FOR TESTING, HAS TO BE REMOVED LATER
  - debug:
      msg: "{{ openldap_server_random_rootpw }}"

  - name: Generate the root password for ldap
    shell: "slappasswd -s {{ openldap_server_random_rootpw }} "
    register: root_password

  # - name: Copy the slapd.conf configuration file for Redhat
  #   template:
  #     src: slapd.conf.j2
  #     dest: "{{ openldap_server_app_path }}/slapd.conf"
  #   when: ansible_os_family == "RedHat"
  #   notify: 
  #   - restart slapd

  - name: Copy the slapd.conf configuration file
    template: src=slapd.conf_ubuntu.j2 dest={{ openldap_server_app_path }}/slapd.conf
#    when: ansible_os_family == "Debian"
    notify: 
    - restart slapd
  
  - name: Copy the ldap.conf configuration file
    template: src=ldap.conf.j2 dest={{ openldap_server_app_path }}/ldap.conf

  become: yes
