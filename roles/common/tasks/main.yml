- block: 
     - name: remove complete {{ fworch_home }} dir 
       file:
          state: absent
          path: "{{ fworch_home }}"

     - name: update operating system packages .deb based
       apt:
         upgrade: dist
       when: ansible_facts['distribution'] == "Ubuntu" or ansible_facts['distribution'] == "Debian"

     - name: update operating system packages .rpm based (untested)
       apt:
         upgrade: dist
       when: ansible_facts['distribution'] == "Red Hat" or ansible_facts['distribution'] == "CentOS"

     - name: install package rsyslog
       package:
        name: "rsyslog"
        state: present

     - name: create log dir for {{ product_name }} on ubuntu - owner syslog
       file:
         path: "/var/log/{{ product_name }}/"
         state: directory
         owner: syslog
         group: syslog
         mode: "0775"
       when: ansible_facts['distribution'] == "Ubuntu"
         
     - name: create log dir for {{ product_name }} on debian - owner root
       file:
         path: "/var/log/{{ product_name }}/"
         state: directory
         owner: root
         group: root
         mode: "0775"
       when: ansible_facts['distribution'] == "Debian"
         
     - name: edit rsyslog
       blockinfile:
         path: "/etc/rsyslog.d/30-{{ product_name }}.conf"
         create: yes
         block: |
             # syslog for {{ product_name }}
             # Log {{ product_name }} log messages to file
             local6.warning                 /var/log/{{ product_name }}/{{ product_name }}.error
             local6.notice                  /var/log/{{ product_name }}/{{ product_name }}.log
             local6.=info                   /var/log/{{ product_name }}/{{ product_name }}.login
             local6.debug                   /var/log/{{ product_name }}/{{ product_name }}.debug
             local4.*                       /var/log/{{ product_name }}/ldap.log


     - name: edit logrotate
       blockinfile:
         path: "/etc/logrotate.d/{{ product_name }}.conf"
         create: yes
         block: |
            /var/log/{{ product_name }}/{{ product_name }}.log /var/log/{{ product_name }}/{{ product_name }}.debug /var/log/{{ product_name }}/{{ product_name }}.error /var/log/{{ product_name }}/{{ product_name }}.login {
               compress
               maxage 7
               rotate 99
               size=+4096k
               missingok
               copytruncate
               sharedscripts
                   prerotate
                           /etc/init.d/{{ product_name }}-import stop >/dev/null
                   endscript
                   postrotate
                           /etc/init.d/{{ product_name }}-import start >/dev/null
                   endscript
            }

     - name: reload rsyslog service
       service:
        name: "rsyslog"
        state: restarted

     - name: create group {{ fworch_user }}
       group:
        name: "{{ fworch_user }}"
        gid: "{{ user_id }}"
        state: present
       
     - name: add user {{ fworch_user }}
       user:
        name: "{{ fworch_user }}"
        comment: "{{ product_name }} User"
        uid: "{{ user_id }}"
        home: "{{ fworch_home }}"
        shell: /bin/bash
        group: "{{ fworch_user }}"
        generate_ssh_key: yes
        ssh_key_bits: 4096
        ssh_key_file: .ssh/id_rsa

     - name: create etc dir
       file:
         path: "{{ fworch_home }}/etc"
         state: directory
         owner: "{{ fworch_user }}"
         group: "{{ fworch_user }}"
         mode: '0755'

     - name: create dir for passwords
       file:
         path: "{{ fworch_home }}/etc/secrets"
         state: directory
         owner: "{{ fworch_user }}"
         group: "{{ fworch_user }}"
         mode: '0700'

     - name: copy iso.conf to target
       copy:
        src: iso.conf
        dest: "{{ fworch_home }}/etc/iso.conf"
        owner: "{{ fworch_user }}"
        group: "{{ fworch_user }}"
        
  become: yes
  
