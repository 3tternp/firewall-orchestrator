# this playbook contains middleware server tests

- name:  wait for middleware port to become available
  wait_for:
    port: "{{ middleware_web_listener_port }}"
    host: "{{ middleware_hostname }}"
    connect_timeout: 1
    delay: 10
    timeout: 25
  when: "not run_on_github|bool"

# curl --request POST --url http://127.0.0.1:8888/AuthenticateUser/ --header 'content-type: application/json' --data '{"Username":"user1_demo","Password":"cactus1"}'
- name: middleware test get jwt valid creds
  uri:
    url: https://{{ middleware_hostname }}:{{ middleware_web_listener_port }}/AuthenticateUser/
    headers:
      Content-Type: application/json
    body:
      Username: user1_demo
      Password: cactus1
  register: sample_jwt
  changed_when: sample_jwt

- debug: var=sample_jwt

- set_fact: jwt_header="{{ ((sample_jwt.stdout.split('.')[0]).split(':')[1]).split('\"')[1] }}"

- debug: var=jwt_header

## adding potentially missing base64 "=" padding to header:
- set_fact: jwt_header="{{ jwt_header }}=" cacheable=yes
  when: "jwt_header|length % 4 > 0"
  loop:
    - 1
    - 2
    - 3

- debug: var=jwt_header

- set_fact: jwt_header="{{ jwt_header|b64decode }}"
- debug: var=jwt_header
- set_fact: jwt_type="{{ jwt_header.typ }}"
- debug: var=jwt_type

- name: middleware get jwt test valid creds output
  debug:
    msg: "ERROR unexpected jwt test result (jwt_type does not match 'JWT'): {{ jwt_type }}"
  when: "jwt_type is not match('JWT')"

- set_fact: jwt_encoded_payload="{{ sample_jwt.stdout.split('.')[1] }}"

- name: show jwt encoded payload pre padding
  debug: var=jwt_encoded_payload
## adding potentially missing base64 = padding to payload:
- set_fact: jwt_encoded_payload="{{ jwt_encoded_payload }}=" cacheable=yes
  when: "jwt_encoded_payload|length % 4 > 0"
  loop:
    - 1
    - 2
    - 3

- name: show jwt encoded payload post padding
  debug: var=jwt_encoded_payload

- set_fact: jwt_payload="{{ jwt_encoded_payload|b64decode }}"

- name: show jwt decoded payload
  debug: var=jwt_payload

- set_fact: jwt_unique_user_name="{{ jwt_payload.unique_name }}"
  when: "'unique_name' in jwt_payload"

- set_fact: jwt_unique_user_name="{{ jwt_payload.name }}"
  when: "'name' in jwt_payload"

- name: middleware get jwt check valid creds output user user1_demo
  debug:
    msg: "ERROR unexpected jwt test result (username does not match 'user1_demo'): {{ jwt_unique_user_name }}"
  when: "jwt_unique_user_name is not match('user1_demo')"

- name: middleware test get jwt wrong creds
  command: |
    curl --request POST --insecure 
      --url https://{{ middleware_hostname }}:{{ middleware_web_listener_port }}/AuthenticateUser/
      --header 'content-type: application/json' 
      --data '{"Username":"user1_demo","Password":"wrong-pwd"}'
  register: sample_jwt
  changed_when: false

- name: middleware get jwt test wrong creds output
  debug:
    msg: "ERROR unexpected jwt test result (not equal 'InvalidCredentials'): {{ sample_jwt.stdout }}"
  when: sample_jwt.stdout is not match('InvalidCredentials')
