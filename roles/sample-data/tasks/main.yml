# this playbook sets up some sample devices with configs to play around with
# postgresql-client

- name: create import sample user and copy configs
  include_tasks: setup-sample-import.yml

- name: install package postgresql-client for adding sample devices to db
  package:
    name: postgresql-client
    state: present
  become: yes

- name: add localhost hostkey to known_hosts - remove before adding to stay idempotent
  # todo:
  # I don't dare to change this, but my tests produce an error for "$ ssh-keygen -R localhost":
  # "Host localhost not found in /home/alf/.ssh/known_hosts"
  # Maybe localhost is added to known_hosts earlier?
  shell: "ssh-keygen -R localhost; ssh-keyscan localhost >> ~/.ssh/known_hosts"
  become: yes
  become_user: "{{ fworch_user }}"

- name: create sample devices in database
  import_tasks: create-devices.yml

- name: insert admin tenant0 to device mapping - tenant0 can see all devices
  postgresql_query:
    db: "{{ fworch_db_name }}"
    query: >
      DO $do$ BEGIN IF NOT EXISTS (SELECT * FROM tenant_to_device LEFT JOIN tenant USING (tenant_id) WHERE tenant_name='tenant0')
        THEN INSERT INTO tenant_to_device (tenant_id, device_id) 
          select tenant.tenant_id, device.dev_id FROM tenant, device WHERE tenant_name='tenant0'; 
        END IF; 
      END $do$
  become: yes
  become_user: postgres

- name: scan localhost ssh keys
  shell: "ssh-keyscan -H 127.0.0.1 >> ~/.ssh/known_hosts"
  become: yes
  become_user: "{{ fworch_user }}" 

- name: establish cron job to simulate hourly changes to configs
  import_tasks: setup-config-changes.yml

# - name: restart importing sample configs
#   #command: "/etc/init.d/{{ product_name }}-importer restart"
#   ansible.builtin.systemd:
#     name: "{{ product_name }}-importer"
#     state: restarted
#   become: yes

- name: add second ldap database
  import_tasks: add_second_ldap_db.yml
  when: second_ldap_db | bool
