@using FWO.Config.Api
@using FWO.Api.Data
@using System.Text.Json;

@page "/monitoring"
@attribute [Authorize(Roles = "admin, reporter, reporter-viewall, recertifier, workflow-user, workflow-admin, auditor, fw-admin")]

@inject APIConnection apiConnection
@inject UserConfig userConfig

<h3>@(userConfig.GetText("monitoring"))</h3>
@(userConfig.GetText("U7001"))
<hr />

<AuthorizeView Roles="admin, fw-admin, auditor">
    <h5>@(userConfig.GetText("open_alerts"))</h5>
    @if(alertEntrys.Count == 0)
    {
        @(userConfig.GetText("no_open_alerts"))
    }
    else
    {
        <Table TableClass="table table-bordered table-sm table-responsive vheight75 overflow-auto sticky-header" TableItem="Alert" Items="alertEntrys" PageSize="100">
            <Column Context="alert" TableItem="Alert" Title="@(userConfig.GetText("action"))" Field="(x => x.Id)">
                <Template>
                    @if(alert.Source == GlobalConfig.kAutodiscovery)
                    {
                        <button class="btn btn-sm btn-primary" @onclick="() => ShowAutodiscDetails(alert)">@(userConfig.GetText("details"))</button>
                    }
                    else if(alert.AlertCode == AlertCode.NoImport || alert.AlertCode == AlertCode.SuccessfulImportOverdue)
                    {
                        <button class="btn btn-sm btn-primary" @onclick="() => ShowImportDetails(alert)">@(userConfig.GetText("details"))</button>
                    }
                    else if(alert.AlertCode == AlertCode.ImportRunningTooLong)
                    {
                        <button class="btn btn-sm btn-primary" @onclick="() => ShowImportRollback(alert)">@(userConfig.GetText("details"))</button>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-primary" disabled>@(userConfig.GetText("details"))</button>
                    }
                    
                    <AuthorizeView Roles="admin, fw-admin">
                        <Authorized Context="ctx">
                            <button class="btn btn-sm btn-secondary" @onclick="() => Acknowledge(alert)">@(userConfig.GetText("acknowledge"))</button>
                        </Authorized>
                        <NotAuthorized Context="ctx">
                            <button class="btn btn-sm btn-secondary" disabled>@(userConfig.GetText("acknowledge"))</button>
                        </NotAuthorized> 
                    </AuthorizeView>
                </Template>
            </Column>
            <Column TableItem="Alert" Title="@(userConfig.GetText("id"))" Field="@(x => x.Id)" />
            <Column TableItem="Alert" Title="@(userConfig.GetText("timestamp"))" Field="@(x => x.Timestamp)" />
            <Column TableItem="Alert" Title="@(userConfig.GetText("source"))" Field="@(x => x.Source)" />
            <Column TableItem="Alert" Title="@(userConfig.GetText("title"))" Field="@(x => x.Title)" />
            <Column TableItem="Alert" Title="@(userConfig.GetText("code"))" Field="@(x => x.AlertCode)" />
            <Column TableItem="Alert" Title="@(userConfig.GetText("management"))" Field="@(x => x.ManagementId)" />
            <Column TableItem="Alert" Title="@(userConfig.GetText("description"))" Field="@(x => x.Description)" />
            <Pager ShowPageNumber="true" ShowTotalCount="true" />
        </Table>
    }
</AuthorizeView>

<AutoDiscovery Actions="actActions" @bind-Display="AutoDiscoverMode" Closing="async () => {AutoDiscoverMode = false; await Refresh();}"/>
<ImportDetails ImportStatus="actStatus" @bind-DetailsMode="DetailsMode"/>
<ImportRollback ManagementId="actMgmtId" LastIncompleteImport="LastIncompleteImport" @bind-RollbackMode="RollbackMode" Closing="async () => {RollbackMode = false; await Refresh();}"/>


@code
{
    [CascadingParameter]
    Action<Exception?, string, string, bool>? DisplayMessageInUi { get; set; }

    private List<Alert> alertEntrys = new List<Alert>();
    private List<ActionItem> actActions = new List<ActionItem>();
    private bool AutoDiscoverMode = false;
    private int actMgmtId = 0;
    private ImportControl[]? LastIncompleteImport { get; set; }
    private bool RollbackMode = false;
    private ImportStatus actStatus = new ImportStatus();
    private bool DetailsMode = false;
 
    protected override async Task OnInitializedAsync()
    {
        await Refresh();
    }

    private async Task Refresh()
    {
        try
        {
            alertEntrys = await apiConnection.SendQueryAsync<List<Alert>>(MonitorQueries.getOpenAlerts);
        }
        catch (Exception exception)
        {
            DisplayMessageInUi!(exception, userConfig.GetText("fetch_log_entrys"), "", true);
        }
    }

    private async Task Acknowledge(Alert alert)
    {
        try
        {
            var Variables = new 
            { 
                id = alert.Id,
                ackUser = userConfig.User.DbId,
                ackTime = DateTime.Now
            };
            await apiConnection.SendQueryAsync<ReturnId>(MonitorQueries.acknowledgeAlert, Variables);
            alertEntrys.Remove(alert);
        }
        catch (Exception exception)
        {
            DisplayMessageInUi!(exception, userConfig.GetText("acknowledge_alert"), "", true);
        }
    }

    private void ShowAutodiscDetails(Alert alert)
    {
        try
        {
            actActions = new List<ActionItem>() { new ActionItem(alert) }; 
            AutoDiscoverMode = true;
        }
        catch (Exception exception)
        {
            DisplayMessageInUi!(exception, userConfig.GetText("handle_alert"), "", true);
        }
    }

    private void ShowImportRollback(Alert alert)
    {
        try
        {
            actMgmtId = alert.ManagementId ?? throw new Exception($"Missing ManagementId!");
            LastIncompleteImport = JsonSerializer.Deserialize<ImportControl[]?>(alert.JsonData ?? throw new Exception($"Missing Import Data!"));
            RollbackMode = true;
        }
        catch (Exception exception)
        {
            DisplayMessageInUi!(exception, userConfig.GetText("handle_alert"), "", true);
        }
    }

    private void ShowImportDetails(Alert alert)
    {
        try
        {
            actStatus = JsonSerializer.Deserialize<ImportStatus>(alert.JsonData ?? throw new Exception($"Missing Import Data!")) ?? throw new Exception($"Import Data not converted!");
            DetailsMode = true;
        }
        catch (Exception exception)
        {
            DisplayMessageInUi!(exception, userConfig.GetText("handle_alert"), "", true);
        }
    }
}
