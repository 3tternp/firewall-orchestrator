@using BlazorTable
@using System.Linq
@using System.Net
@using FWO.Api.Data
@using FWO.Api.Client
@using FWO.Config.Api
@using FWO.Middleware.Client
@using FWO.Middleware.RequestParameters
@using RestSharp

@page "/settings/tenants"
@attribute [Authorize(Roles = $"{GlobalConst.kAdmin}, {GlobalConst.kAuditor}, {GlobalConst.kFwAdmin}")]

@inject ApiConnection apiConnection
@inject MiddlewareClient middlewareClient
@inject UserConfig userConfig

<h3>@(userConfig.GetText("tenants"))</h3>
@(userConfig.GetText("U5212"))
<hr />

@if (addDeleteAllowed)
{
    <div class="form-group row m-0 w-content">
    <button type="button" class="btn btn-sm btn-success mr-2 mb-2 mt-2"
        @onclick="NewTenant">@(userConfig.GetText("add_tenant"))</button>
    @if (showCleanupButton)
        {
            <button type="button" class="btn btn-sm btn-danger m-2"
                @onclick="RequestRemoveSampleData">@(userConfig.GetText("remove_sample_data"))</button>
        }
    </div>
}
<div class="mt-2">
    <Table class="table table-sm table-bordered table-responsive vheight75 overflow-auto sticky-header"
        TableItem="Tenant" Items="tenants" PageSize="0" ColumnReorder="true">
        <Column TableItem="Tenant" Title="@(userConfig.GetText("action"))" Field="(x => x.Id)" Sortable="false"
            Filterable="false">
            <Template>
                <div class="btn-group">
                    @if (context.Id != 1)
                    {
                        <button type="button" class="btn btn-sm btn-warning"
                            @onclick="() => EditTenant(context)">@(userConfig.GetText("edit"))</button>
                    }
                </div>
            </Template>
        </Column>
        <Column TableItem="Tenant" Title="@(userConfig.GetText("name"))" Field="@(x => x.Name)" Sortable="true"
            Filterable="true" />
        <Column TableItem="Tenant" Title="@(userConfig.GetText("comment"))" Field="@(x => x.Comment)" Sortable="true"
            Filterable="true">
            <Template>
                @if (context.Id != 1)
                {
                    @(context.Comment)
                }
                else
                {
                    <label>@(userConfig.GetText("U5208"))</label>
                }
            </Template>
        </Column>
        <Column TableItem="Tenant" Title="@(userConfig.GetText("project"))" Field="@(x => x.Project)" Sortable="true"
            Filterable="true" />
    </Table>
</div>

<PopUp Title="@(AddTenantMode ? userConfig.GetText("add_tenant"): userConfig.GetText("edit_tenant"))"
    Show="@EditTenantMode" Large="true" OnClose="() => EditTenantMode = false">

    <Body>
        @if (EditTenantMode)
        {
            <form>
                <div class="form-group row">
                    <label for="tenantName"
                        class="col-sm-3 col-form-label col-form-label-sm">@(userConfig.GetText("name"))*:</label>
                    @if (AddTenantMode)
                    {
                        <div class="col-sm-9">
                            <input id="tenantName" type="text" class="form-control form-control-sm" @bind="actTenant.Name" />
                        </div>
                    }
                    else
                    {
                        <label class="col-sm-9">@actTenant.Name</label>
                    }
                </div>
                <div class="form-group row">
                    <label for="tenantComment"
                        class="col-sm-3 col-form-label col-form-label-sm">@(userConfig.GetText("comment")):</label>
                    <div class="col-sm-9">
                        <input id="tenantComment" type="text" class="form-control form-control-sm"
                            @bind="actTenant.Comment" />
                    </div>
                </div>
                <div class="form-group row">
                    <label for="tenantProject"
                        class="col-sm-3 col-form-label col-form-label-sm">@(userConfig.GetText("project")):</label>
                    <div class="col-sm-9">
                        <input id="tenantProject" type="text" class="form-control form-control-sm"
                            @bind="actTenant.Project" />
                    </div>
                </div>
                <div class="form-group row">
                    <label for="tenantDeviceSelection"
                        class="col-sm-3 col-form-label col-form-label-sm">@(userConfig.GetText("tenant_vis_devices")):</label>
                    <div class="col-sm-9">
                        <button type="button" class="btn btn-sm btn-warning w-content"
                            @onclick="() => EditDevicesSelectedForTenant(actTenant)">@(userConfig.GetText("edit"))
                        </button>
                    </div>
                </div>
                <IpSelector IpAddresses="actIpAddresses" @bind-IpsToAdd="ipsToAdd" @bind-IpsToDelete="ipsToDelete" />
            </form>
        }
    </Body>
    <Footer>
        <br><br><br><br><br><br><br><br>
        <div>
            <AuthorizeView Roles="admin, fw-admin">
                <Authorized>
                    @if (addDeleteAllowed)
                    {
                        @if (actTenant.Id != 1)
                        {
                            <div class="button-container left">
                                <button type="button" class="btn btn-sm btn-danger"
                                    @onclick="() => RequestDeleteTenant(actTenant)">@(userConfig.GetText("delete_tenant"))</button>
                            </div>
                        }
                    }
                    <div class="button-container center">
                        <button type="button" class="btn btn-primary"
                            @onclick="() => LeaveModifyTenantMode(cancel:false)">@(userConfig.GetText("save"))</button>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <div class="button-container center">
                        <button type="button" class="btn btn-primary" disabled>@(userConfig.GetText("save"))</button>
                    </div>
                </NotAuthorized>
            </AuthorizeView>
            <div class="button-container right">
                <button type="button" class="btn btn-sm btn-secondary"
                    @onclick="() => LeaveModifyTenantMode(cancel:true)">@(userConfig.GetText("cancel"))</button>
            </div>
        </div>
    </Footer>
</PopUp>

<PopUp Title="@(userConfig.GetText("edit_vis_devices") + ": " + actTenant.Name)" Show="@EditDevicesSelectedForTenantMode" Large="true" OnClose="() => EditDevicesSelectedForTenantMode = false">
    <Body>
        @if (EditDevicesSelectedForTenantMode)
        {
            <DeviceSelectionTenants Environment="Tenant" autoSelectMgmt="false" @bind-DeviceFilter="devicesSelectedForTenant" @bind-CollapseAll="collapseDevices" @bind-SelectAll="selectAll"></DeviceSelectionTenants>
        }
    </Body>
    <Footer>
        <div class="btn-group">
            <AuthorizeView Roles="admin">
                <Authorized>
                    <button type="button" class="btn btn-sm btn-success" @onclick="() => LeaveEditDevicesSelectedForTenantMode(cancel:false)" @onclick:preventDefault>@(userConfig.GetText("save"))</button>
                </Authorized>
                <NotAuthorized>
                    <button type="button" class="btn btn-sm btn-success" disabled>@(userConfig.GetText("save"))</button>
                </NotAuthorized>
            </AuthorizeView>
            <button type="button" class="btn btn-sm btn-secondary" @onclick="() => LeaveEditDevicesSelectedForTenantMode(cancel:true)">
                @(userConfig.GetText("cancel"))
            </button>
        </div>
    </Footer>
</PopUp>

<ConfirmDelete @bind-Display="DeleteTenantMode" PerformAction="DeleteTenant"
    Title="@userConfig.GetText("delete_tenant")" DeleteMessage="@deleteTenantMessage"
    DeleteAllowed="DeleteTenantAllowed" />
<ConfirmDelete @bind-Display="SampleRemoveMode" PerformAction="RemoveSampleData"
    Title="@userConfig.GetText("remove_sample_data")" DeleteMessage="@sampleRemoveMessage"
    DeleteAllowed="sampleRemoveAllowed" />
<InProgress Display="workInProgress" />


@code
{
    [CascadingParameter]
    Action<Exception?, string, string, bool> DisplayMessageInUi { get; set; } = DefaultInit.DoNothing;

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationStateTask { get; set; }

    private List<Tenant> tenants = new List<Tenant>();
    private List<Tenant> sampleTenants = new List<Tenant>();
    private List<Device> devices = new List<Device>();
    private List<Device> remainingDevices = new List<Device>();
    private DeviceFilter devicesSelectedForTenant = new DeviceFilter();
    private DeviceFilter savedDeviceFilter = new DeviceFilter();
    private bool collapseDevices = false;
    private List<UiUser> uiUsers = new List<UiUser>();

    private Tenant actTenant = new Tenant();
    private Device selectedDevice = new Device();
    private bool selectAll = true;

    private bool isTenant0 = false;
    private bool AddTenantMode = false;
    private bool EditTenantMode = false;
    private bool DeleteTenantMode = false;
    private bool DeleteTenantAllowed = false;
    private string deleteTenantMessage = "";
    private bool AddDeviceMode = false;
    private bool EditDevicesSelectedForTenantMode = false;
    private bool DeleteDeviceMode = false;
    private bool SampleRemoveMode = false;
    private bool showCleanupButton = false;
    private bool sampleRemoveAllowed = false;
    private string sampleRemoveMessage = "";
    private bool workInProgress = false;

    private List<NwObjectElement> actIpAddresses = new List<NwObjectElement>();
    private List<NwObjectElement> ipsToAdd = new List<NwObjectElement>();
    private List<NwObjectElement> ipsToDelete = new List<NwObjectElement>();

    private bool addDeleteAllowed = false;


    protected override async Task OnInitializedAsync()
    {
        try
        {
            addDeleteAllowed = authenticationStateTask!.Result.User.IsInRole(GlobalConst.kAdmin) || authenticationStateTask!.Result.User.IsInRole(GlobalConst.kAuditor);
            RestResponse<List<TenantGetReturnParameters>> middlewareServerResponse = await middlewareClient.GetTenants();
            if (middlewareServerResponse.StatusCode != HttpStatusCode.OK || middlewareServerResponse.Data == null)
            {
                 DisplayMessageInUi(null, userConfig.GetText("get_tenant_data"), userConfig.GetText("E5284"), true);
            }
            else
            {
                tenants = new List<Tenant>();
                foreach (TenantGetReturnParameters apiTenant in middlewareServerResponse.Data)
                {
                    Tenant newTenant = new Tenant(apiTenant);
                    // foreach (TenantViewGateway tenantGateway in apiTenant.UnfilteredGateways)
                    //    newTenant.UnfilteredGatewayIds.Append(tenantGateway.Id);
                    // foreach (TenantViewGateway tenantGateway in apiTenant.SharedGateways)
                    //    newTenant.SharedGatewayIds.Append(tenantGateway.Id);
                    tenants.Add(newTenant);
                }
                AnalyseSampleTenants();
            }

            devices = await apiConnection.SendQueryAsync<List<Device>>(FWO.Api.Client.Queries.DeviceQueries.getDeviceDetails);
            uiUsers = await apiConnection.SendQueryAsync<List<UiUser>>(FWO.Api.Client.Queries.AuthQueries.getUsers);

        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("get_tenant_data"), "", true);
        }
    }

    private void AnalyseSampleTenants()
    {
        sampleTenants = new List<Tenant>();
        foreach (var tenant in tenants)
        {
            if (tenant.Name.EndsWith("_demo"))
            {
                sampleTenants.Add(tenant);
            }
        }
        showCleanupButton = (sampleTenants.Count > 0);
    }

    private async Task NewTenant()
    {
        await EditTenant(new Tenant());
        AddTenantMode = true;
    }

    private async Task EditTenant(Tenant tenant)
    {
        actTenant = tenant;
        isTenant0 = tenant.Id == 1;
        if (AddTenantMode)
        {
            actIpAddresses.Clear();
        }
        else
        {
            actIpAddresses = await
            apiConnection.SendQueryAsync<List<NwObjectElement>>(FWO.Api.Client.Queries.AuthQueries.getTenantNetworks, new
            {
                tenantId
            = actTenant.Id
            });
        }
        ipsToAdd.Clear();
        ipsToDelete.Clear();
        EditTenantMode = true;
    }

    private async Task EditDevicesSelectedForTenant(Tenant tenant)
    {
        savedDeviceFilter = await SyncDeviceSelections(tenant);
        actTenant = tenant;
        // TODO: add device filter to tenant
        EditDevicesSelectedForTenantMode = true;
    }

    private async Task<DeviceFilter> SyncDeviceSelections(Tenant tenant)
    {
        // now getting the details for the current tenant:
        RestResponse<List<TenantGetReturnParameters>> middlewareServerResponse = await middlewareClient.GetTenants();
        if (middlewareServerResponse.StatusCode != HttpStatusCode.OK || middlewareServerResponse.Data == null)
        {
            DisplayMessageInUi(null, userConfig.GetText("get_tenant_data"), userConfig.GetText("E5284"), true);
        }
        else
        {
            tenants.Clear();
            Tenant tenantDetails  = new Tenant();
            foreach (TenantGetReturnParameters apiTenant in middlewareServerResponse.Data)
            {
                tenants.Add(new Tenant(apiTenant));
            }
            AnalyseSampleTenants();
        }

        List<ManagementSelect> allDevs = await apiConnection.SendQueryAsync<List<ManagementSelect>>(DeviceQueries.getDevicesByManagement);
        Tenant tenantDevices = (await apiConnection.SendQueryAsync<List<Tenant>>(AuthQueries.getTenants, new { tenant_id = tenant.Id })).First();

        // initialize all devices (to invisible)
        foreach (ManagementSelect mgm in allDevs)
        {
            mgm.Visible = false;
            mgm.Shared = true;
            foreach (DeviceSelect dev in mgm.Devices)
            {
                dev.Visible = false;
                dev.Shared = true;
            }
        }

        // set dev visibility for all non-shared managements
        foreach (TenantManagement tenMgm in tenantDevices.TenantManagements)
        {
            foreach (ManagementSelect mgm in allDevs)
            {
                if (mgm.Id == tenMgm.VisibleManagement.Id)
                {
                    if (!tenMgm.Shared)
                    {
                        // set management to Visible and Shared = false
                        mgm.Visible = true;
                        mgm.Shared = false;
                    }
                    else
                    {
                        // shared managements visible and shared
                        mgm.Visible = true;
                        mgm.Shared = true;
                    }
                }
            }
        }
        // set explicit gateway visibilities from tenant_to_device table
        foreach (TenantGateway gw in tenantDevices.TenantGateways)
        {
            foreach (ManagementSelect mgm in allDevs)
            {
                foreach (DeviceSelect dev in mgm.Devices)
                {
                    if (dev.Id == gw.VisibleGateway.Id)
                    {
                        dev.Visible = true;
                        dev.Shared = gw.Shared;
                    }
                }
            }
        }

        devicesSelectedForTenant = new DeviceFilter(allDevs);

        return devicesSelectedForTenant;
    }

    private async Task addTenantNetworks()
    {
        foreach (var ipAdd in ipsToAdd)
        {
            var Variables = new
            {
                tenantId = actTenant.Id,
                ip = (ipAdd.Cidr != null && ipAdd.Cidr.Valid ? ipAdd.Cidr.CidrString : null),
                ipEnd = (ipAdd.CidrEnd != null && ipAdd.CidrEnd.Valid ? ipAdd.CidrEnd.CidrString : null),
                name = ipAdd.Name,
                comment = ipAdd.Comment
            };
            await apiConnection.SendQueryAsync<NewReturning>(FWO.Api.Client.Queries.AuthQueries.addTenantNetwork, Variables);
        }
    }

    private async Task deleteTenantNetworks()
    {
        foreach (var ipDel in ipsToDelete)
        {
            var Variables = new
            {
                tenantId = actTenant.Id,
                tenNetId = ipDel.ElemId
            };
            await apiConnection.SendQueryAsync<ReturnId>(FWO.Api.Client.Queries.AuthQueries.deleteTenantNetwork, Variables);
        }
    }

    private void RequestDeleteTenant(Tenant tenant)
    {
        try
        {
            actTenant = tenant;
            if (uiUsers.Exists(user => (user.Tenant != null && user.Tenant.Name == actTenant.Name)))
            {
                deleteTenantMessage = userConfig.GetText("E5283");
                DeleteTenantAllowed = false;
            }
            else
            {
                deleteTenantMessage = userConfig.GetText("U5210") + actTenant.Name + "?";
                DeleteTenantAllowed = true;
            }

            DeleteTenantMode = true;
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("delete_tenant"), "", true);
        }
    }

    private async Task DeleteTenant()
    {
        try
        {
            // delete tenant from Ldap
            TenantDeleteParameters deleteTenantParameters = new TenantDeleteParameters { Name = actTenant.Name, Id = actTenant.Id };
            RestResponse<bool> middlewareServerResponse = await middlewareClient.DeleteTenant(deleteTenantParameters);
            if (middlewareServerResponse.StatusCode != HttpStatusCode.OK || middlewareServerResponse.Data == false)
            {
                DisplayMessageInUi(null, userConfig.GetText("delete_tenant"), userConfig.GetText("E5282"), true);
            }
            else
            {
                tenants.Remove(actTenant);
            }
            DeleteTenantMode = false;
            EditTenantMode = false;
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("delete_tenant"), "", true);
        }
        StateHasChanged();
    }

    private void RequestRemoveSampleData()
    {
        try
        {
            if (sampleTenants.Exists(tenant => (uiUsers.Exists(user => (user.Tenant != null && user.Tenant.Name == tenant.Name)))))
            {
                sampleRemoveMessage = userConfig.GetText("E5283");
                sampleRemoveAllowed = false;
            }
            else
            {
                sampleRemoveMessage = userConfig.GetText("U5209");
                sampleRemoveAllowed = true;
            }
            SampleRemoveMode = true;
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("remove_sample_data"), "", false);
        }
    }

    private async Task RemoveSampleData()
    {
        SampleRemoveMode = false;
        workInProgress = true;
        try
        {
            foreach (var tenant in sampleTenants)
            {
                actTenant = tenant;
                await DeleteTenant();
            }
            showCleanupButton = false;
            workInProgress = false;
            StateHasChanged();
        }
        catch (System.Exception exception)
        {
            workInProgress = false;
            DisplayMessageInUi(exception, userConfig.GetText("remove_sample_data"), "", false);
        }
    }

    @* private void AddDeviceToTenant(Tenant tenant)
    {
        try
        {
            actTenant = tenant;
            remainingDevices = devices.FindAll(x => !Array.Exists(actTenant.TenantDevices, y => y.VisibleDevice.Id == x.Id));
            remainingDevices.Sort((a, b) => a.Name?.CompareTo(b.Name) ?? -1);
            if (remainingDevices.Count == 0)
            {
                DisplayMessageInUi(null, userConfig.GetText("add_device_to_tenant"), userConfig.GetText("E5271"), true);
            }
            else
            {
                selectedDevice = remainingDevices.FirstOrDefault() ?? new Device();
                AddDeviceMode = true;
            }
        }
        catch (System.Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("add_device_to_tenant"), "", false);
        }
    } *@

    @* private void DeleteDeviceFromTenant(Tenant tenant)
    {
        try
        {
            actTenant = tenant;
            if (actTenant.TenantDevices.Length == 0)
            {
                DisplayMessageInUi(null, userConfig.GetText("delete_device_from_tenant"), userConfig.GetText("E5272"), true);
            }
            else
            {
                selectedDevice = actTenant.TenantDevices.FirstOrDefault()?.VisibleDevice ?? new Device();
                DeleteDeviceMode = true;
            }
        }
        catch (System.Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("delete_device_from_tenant"), "", false);
        }
    } *@

    // save tenant data to LDAP and DB
    private async Task LeaveModifyTenantMode(bool cancel = true)
    {
        if (cancel)
        {
            AddTenantMode = false;
            EditTenantMode = false;
            DeleteTenantMode = false;
            AddDeviceMode = false;
            DeleteDeviceMode = false;
            SampleRemoveMode = false;
        }
        else
        {
            try
            {
                if (actTenant.Sanitize())
                {
                    DisplayMessageInUi(null, userConfig.GetText("save_tenant"), userConfig.GetText("U0001"), true);
                }
                if (actTenant.Name == "")
                {
                    DisplayMessageInUi(null, userConfig.GetText("save_tenant"), userConfig.GetText("E5234"), true);
                }
                else if (AddTenantMode)
                {
                    if (tenants.Exists(x => x.Name == actTenant.Name))
                    {
                        DisplayMessageInUi(null, userConfig.GetText("add_tenant"), userConfig.GetText("E5235"), true);
                    }
                    else
                    {
                        // add tenant in local Ldap and db
                        RestResponse<int> middlewareServerResponse = await middlewareClient.AddTenant(actTenant.ToApiParams());
                        if (middlewareServerResponse.StatusCode != HttpStatusCode.OK || middlewareServerResponse.Data == 0)
                        {
                            DisplayMessageInUi(null, userConfig.GetText("add_tenant"), userConfig.GetText("E5281"), true);
                        }
                        else
                        {
                            await addTenantNetworks();
                            actTenant.Id = middlewareServerResponse.Data;
                            tenants.Add(actTenant);
                            AddTenantMode = false;
                            EditTenantMode = false;
                        }
                    }
                }
                else
                {
                    // update tenant in local db
                    RestResponse<bool> middlewareServerResponse = await middlewareClient.UpdateTenant(actTenant.ToApiUpdateParams());
                    if (middlewareServerResponse.StatusCode != HttpStatusCode.OK || middlewareServerResponse.Data == false)
                    {
                        DisplayMessageInUi(null, userConfig.GetText("edit_tenant"), userConfig.GetText("E5285"), true);
                    }
                    else
                    {
                        await deleteTenantNetworks();
                        await addTenantNetworks();
                        EditTenantMode = false;
                    }
                }
                AnalyseSampleTenants();
            }
            catch (Exception exception)
            {
                DisplayMessageInUi(exception, userConfig.GetText("save_tenant"), "", true);
            }
        }
    }

    private void LeaveEditDevicesSelectedForTenantMode(bool cancel = true)
    {
        if (cancel)
        {
            // visibleGateways = new DeviceFilter(savedDeviceFilter);
        }
        else{
            // TODO: set actTenant.visibleDevices
        }
        EditDevicesSelectedForTenantMode = false;
    }
}
