@using FWO.Api.Client
@using FWO.Config.Api
@using FWO.Config.Api.Data
@using System.Net
@using FWO.Middleware.Client
@using FWO.Middleware.RequestParameters
@using RestSharp
@using System.Diagnostics
@using FWO.Api.Data
@using FWO.Logging


@page "/settings/owners"
@attribute [Authorize(Roles = "admin, auditor")]

@inject ApiConnection apiConnection
@inject GlobalConfig globalConfig
@inject UserConfig userConfig
@inject MiddlewareClient middlewareClient

@if(InitComplete)
{
    <h3>@(userConfig.GetText("owners"))</h3>
    @(userConfig.GetText("U5216"))
    <hr />
    @if(userConfig.AllowManualOwnerAdmin)
    {
        <div class="form-group row">
            <button class="btn btn-sm btn-success m-2" @onclick="AddOwner">@(userConfig.GetText("add_owner"))</button>
            <AuthorizeView Roles="admin" Context="ctx">
                <Authorized>
                    @if (recertCalcInProgress == false)
                        {
                            <button class="btn btn-sm btn-info m-2" @onclick:preventDefault="true" @onclick="RecalcRecerts">@(userConfig.GetText("recalc_recerts"))</button>
                        }
                        else
                        {
                            <div class="spinner-border text-primary align-self-center" role="status"></div>
                        }
                </Authorized>
            </AuthorizeView>
            <AuthorizeView Roles="auditor" Context="ctx">
                <Authorized>
                    <button disabled class="btn btn-sm btn-info m-2" @onclick="RecalcRecerts">@(userConfig.GetText("recalc_recerts"))</button>
                </Authorized>
            </AuthorizeView>

            @if (showCleanupButton)
            {
                <button class="btn btn-sm btn-danger m-2" @onclick="RequestRemoveSampleData">@(userConfig.GetText("remove_sample_data"))</button>
            }
            <br><br>
        </div>
    }
    <div class="m-2">
        <Table class="table table-bordered table-responsive vheight75 overflow-auto sticky-header" TableItem="FwoOwner" Items="owners" PageSize="0" ColumnReorder="true">
            @if(userConfig.AllowManualOwnerAdmin)
            {
                <Column TableItem="FwoOwner" Title="@(userConfig.GetText("owners"))" Field="(x => x.Id)" Sortable="false" Filterable="false">
                    <Template>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-warning" @onclick="async () => await EditOwner(context)">@(userConfig.GetText("edit"))</button>
                            @if(!context.IsDefault)
                            {
                                <AuthorizeView Roles="admin" Context="ctx">
                                    <Authorized>
                                        <button class="btn btn-sm btn-danger" @onclick="() => RequestDeleteOwner(context)">@(userConfig.GetText("delete"))</button>
                                    </Authorized>
                                </AuthorizeView>
                            }
                        </div>
                    </Template>
                </Column>
            }
            <Column TableItem="FwoOwner" Title="@(userConfig.GetText("id"))" Field="@(x => x.Id)" Sortable="true" Filterable="true" />
            <Column TableItem="FwoOwner" Title="@(userConfig.GetText("name"))" Field="@(x => x.Name)" Sortable="true" Filterable="true" />
            <Column TableItem="FwoOwner" Title="@(userConfig.GetText("dn"))" Field="@(x => x.Dn)" Sortable="true" Filterable="true" />
            <Column TableItem="FwoOwner" Title="@(userConfig.GetText("group"))" Field="@(x => x.GroupDn)" Sortable="true" Filterable="true" />
            <Column TableItem="FwoOwner" Title="@(userConfig.GetText("tenant"))" Field="@(x => x.TenantId)" Sortable="true">
                <Template>
                    @(context.TenantId != null ? tenants.FirstOrDefault(x => x.Id == context.TenantId)?.Name ?? "" : "" )
                </Template>
            </Column>
            <Column TableItem="FwoOwner" Title="@(userConfig.GetText("recert_interval"))" Field="@(x => x.RecertInterval)" Sortable="true" Filterable="true" />
            <Column TableItem="FwoOwner" Title="@(userConfig.GetText("ext_app_id"))" Field="@(x => x.ExtAppId)" Sortable="true" Filterable="true" />
        </Table>
    </div>

    <PopUp Title="@(userConfig.GetText("edit_owner"))" Show="@EditOwnerMode" Large="true" OnClose="() => EditOwnerMode = false">
        <Body>
            @if (EditOwnerMode)
            {
                <div class="col-sm-12">
                    <div class="form-group row">
                        <div class="col-sm-2">
                            <div class="form-group row">
                                <label class="col-sm-6 col-form-label col-form-label-sm">@(userConfig.GetText("id")):</label>
                                <label class="col-sm-6 col-form-label col-form-label-sm">@(actOwner.Id)</label>
                            </div>
                        </div>
                        <div class="col-sm-10">
                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label col-form-label-sm">@(userConfig.GetText("name"))*:</label>
                                <input type="text" class=" col-sm-10 form-control form-control-sm" @bind="actOwner.Name" />
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label col-form-label-sm">@(userConfig.GetText("dn"))*:</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control form-control-sm" @bind="actOwner.Dn" />
                        </div>
                        <div class="col-sm-2">
                            <button class="btn btn-sm btn-success form-control form-control-sm" @onclick="() => SearchUser()">@(userConfig.GetText("search"))</button>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label col-form-label-sm">@(userConfig.GetText("group"))*:</label>
                        <div class="col-sm-9">
                            <select class=" form-control form-control-sm" @bind="actOwner.GroupDn">
                                <option value="">@(userConfig.GetText("none"))</option>
                                @foreach (UserGroup group in ownerGroups)
                                {
                                    <option value="@group.Dn">@(group.Name)</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label col-form-label-sm">@(userConfig.GetText("tenant")):</label>
                        <div class="col-sm-9">
                            <select class="form-control form-control-sm" @bind="actTenantId">
                                <option value="-1">@(userConfig.GetText("none"))</option>
                                @foreach (Tenant tenant in tenants)
                                {
                                    <option value="@tenant.Id">@(tenant.Name)</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-sm-6">
                            <div class="form-group row">
                                <label class="col-sm-6 col-form-label col-form-label-sm">@(userConfig.GetText("recert_interval")):</label>
                                <div class="col-sm-6">
                                    <input type="text" class="form-control form-control-sm" @bind="actOwner.RecertInterval" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label col-form-label-sm">@(userConfig.GetText("recert_check_every")):</label>
                        <div class="col-sm-2">
                            <input type="number" min="1" class="form-control form-control-sm" @bind="actRecCheckParams.RecertCheckOffset" />
                        </div>
                        <div class="col-sm-2">
                            <select class="form-control form-control-sm" @bind="actRecCheckParams.RecertCheckInterval">
                                @foreach (Interval interval in Enum.GetValues(typeof(Interval)))
                                {
                                    if (interval != Interval.Never && interval != Interval.Years)
                                    {
                                        <option value="@interval">@userConfig.GetText(interval.ToString())</option>
                                    }
                                }
                            </select>
                        </div>
                        @if(actRecCheckParams.RecertCheckInterval == Interval.Weeks)
                        {
                            <label class="col-sm-2 col-form-label col-form-label-sm">@(userConfig.GetText("each_on")):</label>
                            <div class="col-sm-3">
                                <select class="form-control form-control-sm" @bind="actRecCheckParams.RecertCheckWeekday">
                                    <option value="-1">@userConfig.GetText("undefined")</option>
                                    @foreach (DayOfWeek day in Enum.GetValues(typeof(DayOfWeek)))
                                    {
                                        <option value="@((int)day)">@userConfig.GetText(day.ToString())</option>
                                    }
                                </select>
                            </div>
                        }
                        else if(actRecCheckParams.RecertCheckInterval == Interval.Months)
                        {
                            <label class="col-sm-2 col-form-label col-form-label-sm">@(userConfig.GetText("each_on")):</label>
                            <div class="col-sm-3">
                                <input type="number" min="0" max ="31" class="form-control form-control-sm" @bind="actRecCheckParams.RecertCheckDayOfMonth" />
                            </div>
                        }
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label col-form-label-sm">@(userConfig.GetText("ext_app_id")):</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control form-control-sm" @bind="actOwner.ExtAppId" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label col-form-label-sm">@(userConfig.GetText("ip_addresses")):</label>
                        <div class="col-sm-9">
                            @foreach(var ipAdd in actIpAddresses)
                            {
                                <div class="col-sm-12">
                                    <div class="form-group row">
                                        <input type="text" class="col-sm-11 form-control form-control-sm" readonly @bind="ipAdd.Cidr.CidrString" />
                                        <button type="button" class="col-sm-1 btn btn-sm btn-secondary" @onclick:preventDefault @onclick="() => DeleteIp(ipAdd)">x</button>
                                    </div>
                                </div>
                            }
                            <div class="col-sm-12">
                                <div class="form-group row">
                                    <input @onsubmit:preventDefault @onsubmit:stopPropagation type="text" class="col-sm-12 form-control form-control-sm" placeholder="@(userConfig.GetText("insert_ip"))" @bind="newIpString"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </Body>
        <Footer>
            <div class="btn-group">
                <AuthorizeView Roles="admin">
                    <Authorized>
                        <button class="btn btn-sm btn-primary" @onclick="SaveOwner">@(userConfig.GetText("save"))</button>
                    </Authorized>
                    <NotAuthorized>
                        <button class="btn btn-sm btn-primary" disabled>@(userConfig.GetText("save"))</button>
                    </NotAuthorized> 
                </AuthorizeView>
                <button class="btn btn-sm btn-secondary" @onclick="Cancel">@(userConfig.GetText("cancel"))</button>
            </div>
        </Footer>
    </PopUp>

    <PopUp Title="@(userConfig.GetText("assign_user") + ": " + actOwner.Name)" Show="@SearchUserMode" Large="true" OnClose="() => SearchUserMode = false">
        <Body>
            @if (SearchUserMode)
            {
                <form>
                    <form class="form-group row">
                        <label class="col-sm-2 col-form-label col-form-label-sm">@(userConfig.GetText("from_ldap")):</label>
                        <div class="col-sm-3">
                            <select class="form-control-sm col-sm" @bind="selectedLdapId">
                                @foreach (UiLdapConnection ldap in connectedLdaps)
                                {
                                    <option value="@ldap.Id">@(ldap.Name)</option>
                                }
                            </select>
                        </div>
                        <label class="col-sm-2 col-form-label col-form-label-sm">@(userConfig.GetText("search_pattern")):</label>
                        <div class="col-sm-3">
                            <input class="form-control-sm col-sm" type="text" @bind="searchPattern" />
                        </div>
                        <div class="col-sm-2">
                            <button class="btn btn-sm btn-success" @onclick="async() => await SearchUserInLdap(selectedLdapId)" @onclick:preventDefault>@(userConfig.GetText("search"))</button>
                        </div>
                    </form>
                    <form class="form-group row">
                        <label class="col-sm-2 col-form-label col-form-label-sm">@(userConfig.GetText("active_user")):</label>
                        <div class="col-sm-8">
                            <select class="form-control-sm col-sm" @bind="selectedUiUser">
                                @foreach (UiUser user in uiUsers)
                                {
                                    <option value="@user.Dn">@(user.Dn)</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-2">
                            <AuthorizeView Roles="admin">
                                <Authorized>
                                    <button class="btn btn-sm btn-success" @onclick="() => AddUser(selectedUiUser)" @onclick:preventDefault>@(userConfig.GetText("assign"))</button>
                                </Authorized>
                                <NotAuthorized>
                                    <button class="btn btn-sm btn-success" disabled>@(userConfig.GetText("assign"))</button>
                                </NotAuthorized> 
                            </AuthorizeView>
                        </div>
                    </form>
                </form>
            }
        </Body>
        <Footer>
            <div class="btn-group">
                <button class="btn btn-sm btn-secondary" @onclick="CancelSearch">@(userConfig.GetText("cancel"))</button>
            </div>
        </Footer>
    </PopUp>

    <PopUp Title="@(userConfig.GetText("select_from_ldap") + ": " + selectedLdap.Host())" Show="@SearchUserInLdapMode" Large="true" OnClose="() => CancelLdapSearch()">
        <Body>
            @if (SearchUserInLdapMode)
            {
                <form>
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label col-form-label-sm">@(userConfig.GetText("user")):</label>
                        <div class="col-sm-8">
                            <select class="form-control form-control-sm" @bind="selectedLdapUser">
                                @foreach (UiUser user in ldapUsers)
                                {
                                    <option value="@user.Dn">@(user.Dn)</option>
                                }
                            </select>
                        </div>
                        <AuthorizeView Roles="admin">
                            <Authorized>
                                <button class="btn btn-sm btn-success" @onclick="() => AddUser(selectedLdapUser)" @onclick:preventDefault>@(userConfig.GetText("assign"))</button>
                            </Authorized>
                            <NotAuthorized>
                                <button class="btn btn-sm btn-success" disabled>@(userConfig.GetText("assign"))</button>
                            </NotAuthorized> 
                        </AuthorizeView>
                    </div>
                </form>
            }
        </Body>
        <Footer>
            <div class="btn-group">
                <button class="btn btn-sm btn-secondary" @onclick="CancelLdapSearch">@(userConfig.GetText("cancel"))</button>
            </div>
        </Footer>
    </PopUp>

    <ConfirmDelete Display="DeleteOwnerMode" PerformAction="DeleteOwner" Title="@userConfig.GetText("delete_owner")" DeleteMessage="@(userConfig.GetText("U5217") + actOwner.Name + "?")"/>
    <ConfirmDelete Display="CleanupMode" PerformAction="RemoveSampleData" Title="@userConfig.GetText("remove_sample_data")" DeleteMessage="@cleanupMessage"/>
}
else
{
    <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
    </div>
}

@code
{
    [CascadingParameter]
    Action<Exception?, string, string, bool> DisplayMessageInUi { get; set; } = DefaultInit.DoNothing;

    private List<FwoOwner> owners = new List<FwoOwner>();
    private List<FwoOwner> sampleOwners = new List<FwoOwner>();
    private FwoOwner actOwner = new FwoOwner();
    private int actTenantId = -1;

    private List<UserGroup> ownerGroups = new List<UserGroup>();
    private List<Tenant> tenants = new List<Tenant>();

    private List<UiUser> uiUsers = new List<UiUser>();
    private List<UiLdapConnection> connectedLdaps = new List<UiLdapConnection>();
    private UiLdapConnection selectedLdap = new UiLdapConnection();
    private List<UiUser> ldapUsers = new List<UiUser>();
    private string selectedUiUser = "";
    private string selectedLdapUser = "";
    private int selectedLdapId;
    private string searchPattern = "";

    private bool showCleanupButton = false;
    private bool CleanupMode = false;
    private string cleanupMessage = "";
    private bool EditOwnerMode = false;
    private bool AddOwnerMode = false;
    private bool DeleteOwnerMode = false;
    private bool SearchUserMode = false;
    private bool SearchUserInLdapMode = false;
    private bool InitComplete = false;
    private RecertCheckParams actRecCheckParams = new RecertCheckParams();
    private bool recertCalcInProgress = false;

    private List<NwObjectElement> actIpAddresses = new List<NwObjectElement>();
    private bool ipChanged = false;

    private string newIpInt = "";
    private string newIpString
    {
        get => newIpInt;
        set
        {
            if(value != null && value != "")
            {
                NwObjectElement obj = new NwObjectElement(value, 0);
                if (obj.Cidr.Valid)
                {
                    actIpAddresses.Add(obj);
                    newIpInt = "";
                }
            }
            ipChanged = true;
            StateHasChanged();
        }
    }


    protected override async Task OnInitializedAsync()
    {
        try
        {
            owners = await apiConnection.SendQueryAsync<List<FwoOwner>>(FWO.Api.Client.Queries.OwnerQueries.getOwners);
            AnalyseSampleOwners();

            ownerGroups = await GroupAccess.GetGroupsFromInternalLdap(middlewareClient, userConfig, DisplayMessageInUi, true);
            uiUsers = await apiConnection.SendQueryAsync<List<UiUser>>(FWO.Api.Client.Queries.AuthQueries.getUsers);
            uiUsers = uiUsers.FindAll(x => x.DbId != 0);
            connectedLdaps = await apiConnection.SendQueryAsync<List<UiLdapConnection>>(FWO.Api.Client.Queries.AuthQueries.getLdapConnections);

            RestResponse<List<TenantGetReturnParameters>> middlewareServerResponse = await middlewareClient.GetTenants();
            if (middlewareServerResponse.StatusCode != HttpStatusCode.OK || middlewareServerResponse.Data == null)
            {
                DisplayMessageInUi(null, userConfig.GetText("get_tenant_data"), userConfig.GetText("E5284"), true);
            }
            else
            {
                tenants = new List<Tenant>();
                foreach (TenantGetReturnParameters apiTenant in middlewareServerResponse.Data)
                {
                    tenants.Add(new Tenant(apiTenant));
                }
            }
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("fetch_data"), "", true);
        }
        InitComplete = true;
    }

    private void AnalyseSampleOwners()
    {
        sampleOwners = new List<FwoOwner>();
        foreach (var owner in owners)
        {
            if (owner.Name.EndsWith("_demo"))
            {
                sampleOwners.Add(owner);
            }
        }
        showCleanupButton = (sampleOwners.Count > 0);
    }

    private void DeleteIp(NwObjectElement obj)
    {
        actIpAddresses.Remove(obj);
        ipChanged = true;
        StateHasChanged();
    }

    private async Task AddOwner()
    {
        AddOwnerMode = true;
        await EditOwner(new FwoOwner());
    }

    private async Task RecalcRecerts()
    {
        if (recertCalcInProgress == false)
        {
            recertCalcInProgress = true;
            double refreshDuration = 0;
            Stopwatch watch = new System.Diagnostics.Stopwatch();
            string secs = "";
            var noVariables = new {};

            try
            {
                JwtReader jwt = new JwtReader(userConfig.User.Jwt);
                jwt.Validate();

                List<Management> managements = new List<Management>();
                if (jwt.ContainsAllowedRole("admin") || jwt.ContainsAllowedRole("fw-admin"))
                    managements = await apiConnection.SendQueryAsync<List<Management>>(FWO.Api.Client.Queries.DeviceQueries.getManagementsDetails);
                else
                    managements = await apiConnection.SendQueryAsync<List<Management>>(FWO.Api.Client.Queries.DeviceQueries.getManagementDetailsWithoutSecrets);

                watch.Start();
                ReturnId[]? returnIds = 
                    (await apiConnection.SendQueryAsync<NewReturning>(FWO.Api.Client.Queries.RecertQueries.clearOpenRecerts, noVariables)).ReturnIds;
                // the clearOpenRecerts refreshes materialized view view_rule_with_owner as a side-effect
                watch.Stop();
                refreshDuration = watch.ElapsedMilliseconds/1000.0;
                secs = refreshDuration.ToString("0.00");
                Log.WriteDebug("Refresh materialized view view_rule_with_owner", $"refresh took {secs} seconds");

                foreach (FwoOwner owner in owners)
                    await RecalcRecertsOfOwner(owner, managements);
            }
            catch (Exception exception)
            {
                DisplayMessageInUi(exception, userConfig.GetText("fetch_data"), "", true);
            }
            recertCalcInProgress = false;
        }

    }

    private async Task RecalcRecertsOfOwner(FwoOwner owner, List<Management> managements)
    {
        double refreshDuration = 0;
        Stopwatch watch = new System.Diagnostics.Stopwatch();
        string secs = "";
        watch.Start();

        foreach (Management mgm in managements)
        {
            List<RecertificationBase> currentRecerts =
                await apiConnection.SendQueryAsync<List<RecertificationBase>>(FWO.Api.Client.Queries.RecertQueries.getOpenRecerts, new { ownerId = owner.Id, mgmId = mgm.Id });

            if (currentRecerts.Count>0)
            {
                ReturnId[]? returnedIds = (await apiConnection.SendQueryAsync<NewReturning>(FWO.Api.Client.Queries.RecertQueries.addRecertEntries, new  { recerts = currentRecerts })).ReturnIds;
            }
        }

        watch.Stop();
        refreshDuration = watch.ElapsedMilliseconds/1000.0;
        secs = refreshDuration.ToString("0.00");
        Log.WriteDebug("Refresh Recertification", $"refresh for owner {owner.Name} took {secs} seconds");
    }

    private async Task EditOwner(FwoOwner owner)
    {
        try
        {
            actOwner = owner;
            actTenantId = (actOwner.TenantId != null ? (int)actOwner.TenantId : -1);
            actRecCheckParams = (actOwner.RecertCheckParams != null ? System.Text.Json.JsonSerializer.Deserialize<RecertCheckParams>(actOwner.RecertCheckParams) : new RecertCheckParams());
            if(AddOwnerMode)
            {
                actIpAddresses.Clear();
            }
            else
            {
                actIpAddresses = await apiConnection.SendQueryAsync<List<NwObjectElement>>(FWO.Api.Client.Queries.OwnerQueries.getNetworkOwnerships, new { ownerId = actOwner.Id });
            }
            ipChanged = false;
            EditOwnerMode = true;
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("fetch_data"), "", true);
        }
    }

    private async Task SaveOwner()
    {
        try
        {
            actOwner.TenantId = (actTenantId >= 0 ? actTenantId : null);
            if(actRecCheckParams.RecertCheckDayOfMonth == 0)
            {
                actRecCheckParams.RecertCheckDayOfMonth = null;
            }
            if(actRecCheckParams.RecertCheckWeekday == -1)
            {
                actRecCheckParams.RecertCheckWeekday = null;
            }
            actOwner.RecertCheckParams = System.Text.Json.JsonSerializer.Serialize(actRecCheckParams);
            if (actOwner.Sanitize())
            {
                DisplayMessageInUi(null, userConfig.GetText("edit_owner"), userConfig.GetText("U0001"), true);
            }
            if (CheckValues())
            {
                if(AddOwnerMode)
                {
                    await AddOwnerInDb();
                }
                else
                {
                    await UpdateOwnerInDb();
                }
                if(selectedLdap.Id > 0)
                {
                    await addTenantIfNew(actOwner.Dn);
                }
                AnalyseSampleOwners();
                EditOwnerMode = false;
                AddOwnerMode = false;
            }
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("edit_owner"), "", true);
        }
    }

    private async Task AddOwnerInDb()
    {
        var Variables = new
        {
            name = actOwner.Name,
            dn = actOwner.Dn,
            groupDn = actOwner.GroupDn,
            tenantId = actOwner.TenantId,
            recertInterval = actOwner.RecertInterval,
            appIdExternal = actOwner.ExtAppId,
            recertCheckParams = actOwner.RecertCheckParams
        };
        ReturnId[]? returnIds = (await apiConnection.SendQueryAsync<NewReturning>(FWO.Api.Client.Queries.OwnerQueries.newOwner, Variables)).ReturnIds;
        if (returnIds == null)
        {
            DisplayMessageInUi(null, userConfig.GetText("add_owner"), userConfig.GetText("E5291"), true);
        }
        else
        {
            actOwner.Id = returnIds[0].NewId;
            await addNetworkOwners();
            owners.Add(actOwner);
        }
    }

    private async Task UpdateOwnerInDb()
    {
        var Variables = new
        {
            id = actOwner.Id,
            name = actOwner.Name,
            dn = actOwner.Dn,
            groupDn = actOwner.GroupDn,
            tenantId = actOwner.TenantId,
            recertInterval = actOwner.RecertInterval,
            appIdExternal = actOwner.ExtAppId,
            recertCheckParams = actOwner.RecertCheckParams
        };
        int udId = (await apiConnection.SendQueryAsync<ReturnId>(FWO.Api.Client.Queries.OwnerQueries.updateOwner, Variables)).UpdatedId;
        if(udId != actOwner.Id)
        {
            DisplayMessageInUi(null, userConfig.GetText("edit_owner"), userConfig.GetText("E5291"), true);
        }
        else
        {
            // TODO: block editing single ip addresses - either delete them or add new ones.
            if(ipChanged)
            {
                await apiConnection.SendQueryAsync<ReturnId>(FWO.Api.Client.Queries.OwnerQueries.deleteNetworkOwnerships, new { ownerId = actOwner.Id });
                actOwner.NwObjElements.Clear();
                await addNetworkOwners();
            }
            owners[owners.FindIndex(x => x.Id == actOwner.Id)] = actOwner;
        }
    }

    private async Task addNetworkOwners()
    {
        foreach(var ipAdd in actIpAddresses)
        {
            var Variables = new
            {
                ownerId = actOwner.Id,
                ip = (ipAdd.Cidr != null && ipAdd.Cidr.Valid ? ipAdd.Cidr.CidrString : null)
            };
            await apiConnection.SendQueryAsync<NewReturning>(FWO.Api.Client.Queries.OwnerQueries.newNetworkOwnership, Variables);
            actOwner.NwObjElements.Add(ipAdd);
        }
    }

    private void Cancel()
    {
        EditOwnerMode = false;
        AddOwnerMode = false;
        DeleteOwnerMode = false;
        CleanupMode = false;
    }

    private void RequestDeleteOwner(FwoOwner owner)
    {
        actOwner = owner;
        DeleteOwnerMode = true;
    }

    private async Task DeleteOwner()
    {
        try
        {
            await apiConnection.SendQueryAsync<ReturnId>(FWO.Api.Client.Queries.OwnerQueries.deleteOwner, new { id = actOwner.Id });
            owners.Remove(actOwner);
            DeleteOwnerMode = false;
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("delete_owner"), "", true);
        }
        StateHasChanged();
    }

    private void RequestRemoveSampleData()
    {
        cleanupMessage = userConfig.GetText("U5218");
        CleanupMode = true;
    }

    private async Task RemoveSampleData()
    {
        foreach (var owner in sampleOwners)
        {
            actOwner = owner;
            await DeleteOwner();
        }
        CleanupMode = false;
        showCleanupButton = false;
        StateHasChanged();
    }

    private bool CheckValues()
    {
        if (actOwner.Name == null || actOwner.Name == "")
        {
            DisplayMessageInUi(null, userConfig.GetText("edit_owner"), userConfig.GetText("E5102"), true);
            return false;
        }
        if (AddOwnerMode && owners.Exists(x => x.Name == actOwner.Name))
        {
            DisplayMessageInUi(null, userConfig.GetText("add_owner"), userConfig.GetText("E5235"), true);
            return false;
        }
        if (actOwner.Dn == "" && actOwner.GroupDn == "")
        {
            DisplayMessageInUi(null, userConfig.GetText("edit_owner"), userConfig.GetText("E5292"), true);
            return false;
        }
        return true;
    }

    private void SearchUser()
    {
        selectedUiUser = (uiUsers.Count == 0 ? "" : uiUsers.First().Dn);
        selectedLdapId = (connectedLdaps.Count == 0 ? 0 : connectedLdaps.First().Id);
        SearchUserMode = true;
    }

    private async Task SearchUserInLdap(int ldapId)
    {
        UiLdapConnection? actLdap = connectedLdaps.FirstOrDefault(x => x.Id == ldapId);
        if (actLdap != null)
        {
            selectedLdap = actLdap;
        }

        if(searchPattern.Length < selectedLdap.PatternLength)
        {
            DisplayMessageInUi(null, userConfig.GetText("search_users"), userConfig.GetText("E5252") + selectedLdap.PatternLength, true);
        }
        else
        {
            // get users from Ldap
            try
            {
                ldapUsers.Clear();
                LdapUserGetParameters userGetParameters = new LdapUserGetParameters { LdapId = selectedLdap.Id, SearchPattern = searchPattern };
                RestResponse<List<LdapUserGetReturnParameters>> middlewareServerResponse = await middlewareClient.GetLdapUsers(userGetParameters);
                if (middlewareServerResponse.StatusCode != HttpStatusCode.OK || middlewareServerResponse.Data == null)
                {
                    DisplayMessageInUi(null, userConfig.GetText("fetch_users"), userConfig.GetText("E5208"), true);
                }
                else
                {
                    foreach (var user in middlewareServerResponse.Data)
                    {
                        UiUser newUser = new UiUser() { Dn = user.UserDn, Name = (new DistName(user.UserDn)).UserName };
                        ldapUsers.Add(newUser);
                    }
                }
            }
            catch (System.Exception)
            {
                DisplayMessageInUi(null, userConfig.GetText("fetch_users"), "", true);
            }

            selectedLdapUser = (ldapUsers.Count == 0 ? "" : ldapUsers.First().Dn);
            SearchUserInLdapMode = true;
            SearchUserMode = false;
        }
    }

    private void AddUser(string userDn)
    {
        actOwner.Dn = userDn;
        SearchUserInLdapMode = false;
        SearchUserMode = false;
    }

    private async Task addTenantIfNew(string Dn)
    {
        try
        {
            if (selectedLdap.TenantLevel == 0 || selectedLdap.IsInternal())
            {
                return;
            }
            string tenantName = (new DistName(Dn)).getTenant(selectedLdap.TenantLevel);
            Tenant[] tenants = await apiConnection.SendQueryAsync<Tenant[]>(AuthQueries.getTenantId, new { tenant_name = tenantName }, "getTenantId");
            if (tenants.Count() == 0)
            {
                // tenant unknown: create in db
                var Variables = new 
                { 
                    name = tenantName,
                    project = "",
                    comment = "",
                    viewAllDevices = false,
                    create = DateTime.Now
                };
                await apiConnection.SendQueryAsync<NewReturning>(FWO.Api.Client.Queries.AuthQueries.addTenant, Variables);
            }
        }
        catch (Exception exception)
        {
            Log.WriteAudit("AddTenant", $"Adding new Tenant locally failed: {exception.Message}");
        }
    }

    private void CancelSearch()
    {
        SearchUserMode = false;
    }

    private void CancelLdapSearch()
    {
        selectedLdap = new UiLdapConnection();
        SearchUserInLdapMode = false;
        SearchUserMode = true;
    }
}
