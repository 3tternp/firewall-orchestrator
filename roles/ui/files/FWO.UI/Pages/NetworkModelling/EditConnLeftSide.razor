@using FWO.Config.Api
@using FWO.Ui.Display
@using FWO.Api.Data

@inject ApiConnection apiConnection
@inject UserConfig userConfig

<Sidebar Collapsible="true" Resizeable="true" PositionLeft="true" @bind-Width="sidebarLeftWidth" >
    <div class="form-group row col-sm-12">
        <div class="mt-3 ml-2 col-sm-6">
            <h3>@(userConfig.GetText("library"))</h3>
        </div>
        <div class="mt-3 col-sm-5 justify-content-end">
            <label class="col-form-label text-success">@Application.Name</label>
        </div>
    </div>
    <div class="col-sm-11 border rounded m-2 p-2">
        @if(DisplayInterfaces)
        {
            <h5>@(userConfig.GetText("interfaces"))</h5>
            <div class="form-group row">
                <div class="col-sm-9">
                    <select class="form-control form-control-sm" @bind="selectedInterface">
                        @foreach (var interf in Interfaces)
                        {
                            <option class="draggable" draggable="true" @ondragstart="@(() => {if(selectedInterface > 0) HandleDragStart(ResolveConn(selectedInterface));})" value="@interf.Id">@interf.Name</option>
                        }
                    </select>
                </div>
                <div class="col-sm-3">
                    @if(selectedInterface > 0)
                    {
                        <button type="button" class="btn btn-sm btn-primary w-100" @onclick="() => IntToConn(ResolveConn(selectedInterface))">@(userConfig.GetText("use"))</button>
                    }
                </div>
            </div>
            <br><br>
        }
        @if(userConfig.AllowServerInConn)
        {
            <h5>@(userConfig.GetText("app_server"))</h5>
            <div class="form-group row">
                <div class="col-sm-9">
                    <select class="form-control form-control-sm" @bind="selectedAppServer" multiple>
                        @foreach (var appserver in AppServer)
                        {
                            <option class="draggable" draggable="true" @ondragstart="@(() => HandleDragStart(ResolveElem(selectedAppServer)))" value="@appserver.Id">@NwObjDisplay.DisplayWithName(appserver)</option>
                        }
                    </select>
                </div>
                <div class="col-sm-3">
                @if(ToSrcAllowed && selectedAppServer.Length > 0)
                {
                    <button type="button" class="btn btn-sm btn-primary w-100" @onclick="() => AppServerToSource(ResolveElem(selectedAppServer))">@(userConfig.GetText("to_source"))</button>
                }
                @if(ToDestAllowed && selectedAppServer.Length > 0)
                {
                    <button type="button" class="btn btn-sm btn-primary w-100 mt-2" @onclick="() => AppServerToDest(ResolveElem(selectedAppServer))">@(userConfig.GetText("to_dest"))</button>
                }
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-danger" @onclick="DataInconsistent">@(userConfig.GetText("data_inconsistent"))</button>
            <br><br>
        }
        <h5>@(userConfig.GetText("app_roles"))</h5>
        <div class="form-group row">
            <div class="col-sm-9">
                <select class="form-control form-control-sm" @bind="selectedAppRoles" multiple>
                    @foreach (var appRole in ConnHandler.AppRoles)
                    {
                        <option class="draggable" draggable="true" @ondragstart="@(() => HandleDragStart(ResolveAppRole(selectedAppRoles)))" value="@appRole.Id">
                            <div class="col-sm-12 dropzone" 
                                ondragover="event.preventDefault();"
                                ondragstart="event.dataTransfer.setData('', event.target.id);"
                                @ondrop="() => HandleIpDropToAppRole(appRole)">
                                @appRole.Name
                            </div>
                        </option>
                    }
                </select>
            </div>
            <div class="col-sm-3">
                @if(ToSrcAllowed && selectedAppRoles.Length > 0)
                {
                    <button type="button" class="btn btn-sm btn-primary w-100" @onclick="() => ConnHandler.AppRolesToSource(ResolveAppRole(selectedAppRoles))">@(userConfig.GetText("to_source"))</button>
                }
                @if(ToDestAllowed && selectedAppRoles.Length > 0)
                {
                    <button type="button" class="btn btn-sm btn-primary w-100 mt-2" @onclick="() => ConnHandler.AppRolesToDestination(ResolveAppRole(selectedAppRoles))">@(userConfig.GetText("to_dest"))</button>
                }
            </div>
        </div>
        <div class="form-group row">
            <div class="col-sm-12">
                <button type="button" class="btn btn-sm btn-success" @onclick="() => ConnHandler.CreateAppRole()">@(userConfig.GetText("add_app_role"))</button>
                @if(selectedAppRoles.Length == 1)
                {
                    <button type="button" class="btn btn-sm btn-warning" @onclick="() => ConnHandler.EditAppRole(ResolveAppRole(selectedAppRoles).First())">@(userConfig.GetText("edit_app_role"))</button>
                    <button type="button" class="btn btn-sm btn-danger" @onclick="() => {ConnHandler.RequestDeleteAppRole(ResolveAppRole(selectedAppRoles).First());selectedAppRoles = new long[]{};}">@(userConfig.GetText("delete"))</button>
                }
            </div>
        </div>
        <br><br>
        @if(userConfig.AllowServiceInConn)
        {
            @if(ToSvcAllowed)
            {
                <h5>@(userConfig.GetText("services"))</h5>
                <div class="form-group row">
                    <div class="col-sm-9">
                        <select class="form-control form-control-sm" @bind="selectedServices" multiple>
                            @foreach (var service in ConnHandler.AvailableServices)
                            {
                                <option class="draggable" draggable="true" @ondragstart="@(() => HandleDragStart(ResolveSvc(selectedServices)))" value="@service.Id">@DisplayService(service)</option>
                            }
                        </select>
                    </div>
                    <div class="col-sm-3">
                        @if(ToSvcAllowed && selectedServices.Length > 0)
                        {
                            <button type="button" class="btn btn-sm btn-primary w-100" @onclick="() => {ConnHandler.ServicesToConn(ResolveSvc(selectedServices));ConnHandlerChanged.InvokeAsync(ConnHandler);}">@(userConfig.GetText("to_service"))</button>
                        }
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-success" @onclick="async () => WrapAsync(ConnHandler.CreateService)">@(userConfig.GetText("add_service"))</button>
                @if(selectedServices.Length == 1)
                {
                    <button type="button" class="btn btn-sm btn-warning" @onclick="async () => { await ConnHandler.EditService(ResolveSvc(selectedServices).First()); await ConnHandlerChanged.InvokeAsync(ConnHandler);}">@(userConfig.GetText("edit_service"))</button>
                    <button type="button" class="btn btn-sm btn-danger" @onclick="() => {ConnHandler.RequestDeleteService(ResolveSvc(selectedServices).First());selectedServices = new long[]{};ConnHandlerChanged.InvokeAsync(ConnHandler);}">@(userConfig.GetText("delete"))</button>
                }
                <br><br>
            }
        }
        @if(ToSvcAllowed)
        {
            <h5>@(userConfig.GetText("services_groups"))</h5>
            <div class="form-group row">
                <div class="col-sm-9">
                    <select class="form-control form-control-sm" @bind="selectedServiceGroups" multiple>
                        @foreach (var grp in ConnHandler.AvailableServiceGroups)
                        {
                            <option class="draggable" draggable="true" @ondragstart="@(() => HandleDragStart(ResolveSvcGrp(selectedServiceGroups)))" value="@grp.Id">@DisplayServiceGroup(grp)</option>
                        }
                    </select>
                </div>
                <div class="col-sm-3">
                    @if(ToSvcAllowed && selectedServiceGroups.Length > 0)
                    {
                        <button type="button" class="btn btn-sm btn-primary w-100" @onclick="() => {ConnHandler.ServiceGrpsToConn(ResolveSvcGrp(selectedServiceGroups));ConnHandlerChanged.InvokeAsync(ConnHandler);}">@(userConfig.GetText("to_service"))</button>
                    }
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-success"@onclick="async () => WrapAsync(ConnHandler.CreateServiceGroup)">@(userConfig.GetText("add_service_group"))</button>
            @if(selectedServiceGroups.Length == 1)
            {
                <button type="button" class="btn btn-sm btn-warning"@onclick="async () => { await ConnHandler.EditServiceGroup(ResolveSvcGrp(selectedServiceGroups).First()); await ConnHandlerChanged.InvokeAsync(ConnHandler);}">@(userConfig.GetText("edit_service_group"))</button>
                <button type="button" class="btn btn-sm btn-danger"@onclick="() => {ConnHandler.RequestDeleteServiceGrp(ResolveSvcGrp(selectedServiceGroups).First());selectedServiceGroups = new long[]{};ConnHandlerChanged.InvokeAsync(ConnHandler);}">@(userConfig.GetText("delete"))</button>
            }
        }
    </div>
</Sidebar>
<ConfirmDelete @bind-Display="ConnHandler.DeleteServiceGrpMode" PerformAction="async () => WrapAsync(ConnHandler.DeleteServiceGroup)" Title="@userConfig.GetText("delete_service_group")" DeleteMessage="@ConnHandler.deleteMessage"/>
<ConfirmDelete @bind-Display="ConnHandler.DeleteServiceMode" PerformAction="async () => WrapAsync(ConnHandler.DeleteService)" Title="@userConfig.GetText("delete_service")" DeleteMessage="@ConnHandler.deleteMessage"/>

@code
{
    [CascadingParameter]
    Action<Exception?, string, string, bool> DisplayMessageInUi { get; set; } = DefaultInit.DoNothing;

    [Parameter] 
    public FwoOwner Application { get; set; } = new FwoOwner();

    [Parameter] 
    public DnDContainer Container { get; set; } = new();

    [Parameter]
    public EventCallback<DnDContainer> ContainerChanged { get; set; }

    [Parameter]
    public int Width { get; set; }

    [Parameter]
    public EventCallback<int> WidthChanged { get; set; }

    [Parameter]
    public ModellingConnectionHandler ConnHandler { get; set; }

    [Parameter]
    public EventCallback<ModellingConnectionHandler> ConnHandlerChanged { get; set; }


    [Parameter]
    public Func<List<NetworkObject>, bool> AppServerToSource { get; set; } = DefaultInit.DoNothingSync;

    [Parameter]
    public Func<List<NetworkObject>, bool> AppServerToDest { get; set; } = DefaultInit.DoNothingSync;

    [Parameter]
    public bool DisplayInterfaces { get; set; } = false;

    [Parameter] 
    public List<NetworkConnection> Interfaces { get; set; } = new();

    [Parameter]
    public Func<NetworkConnection, bool> IntToConn { get; set; } = DefaultInit.DoNothingSync;

    [Parameter]
    public bool ToSrcAllowed { get; set; } = true;

    [Parameter]
    public bool ToDestAllowed { get; set; } = true;

    [Parameter]
    public bool ToSvcAllowed { get; set; } = true;


    private List<NetworkObject> AppServer = new List<NetworkObject>(){};
    private long[] selectedAppServer = new long[]{};
    private long[] selectedAppRoles = new long[]{};
    private long[] selectedServices = new long[]{};
    private long[] selectedServiceGroups = new long[]{};
    private long selectedInterface = 0;
    private int sidebarLeftWidth { get { return Width; } set { Width = value; WidthChanged.InvokeAsync(Width);}}


    protected override async Task OnInitializedAsync()
    {
        try
        {
            AppServer = await apiConnection.SendQueryAsync<List<NetworkObject>>(FWO.Api.Client.Queries.ModellingQueries.getAppServer, new { appId = Application.Id });

            if(Interfaces.Count > 0)
            {
                selectedInterface = Interfaces.First().Id;
            }
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("fetch_data"), "", true);
        }
    }

    private void HandleDragStart(NetworkConnection selectedConn)
    {
        Container.Clear();
        Container.ConnElement = selectedConn;
    }

    private void HandleDragStart(List<NetworkObject> selectedIps)
    {
        Container.Clear();
        Container.IpElements = selectedIps;
    }

    private void HandleDragStart(List<AppRole> selectedAppRoles)
    {
        Container.Clear();
        Container.AppRoleElements = selectedAppRoles;
    }

    private void HandleDragStart(List<NetworkService> selectedSvcs)
    {
        Container.Clear();
        Container.SvcElements = selectedSvcs;
    }

    private void HandleDragStart(List<ServiceGroup> selectedSvcGrps)
    {
        Container.Clear();
        Container.SvcGrpElements = selectedSvcGrps;
    }

    private async Task HandleIpDropToAppRole(AppRole appRole)
    {
        if(Container.IpElements.Count > 0)
        {
            appRole.NetworkObjects.AddRange(Container.IpElements);
            // save ???
        }
        Container.Clear();
    }

    private NetworkConnection ResolveConn(long selectedConn)
    {
        return Interfaces.FirstOrDefault(x => x.Id == selectedConn);
    }

    private List<NetworkObject> ResolveElem(long[] selectedIds)
    {
        List<NetworkObject> addedIps = new();
        foreach(var id in selectedIds)
        {
            addedIps.Add(AppServer.FirstOrDefault(x => x.Id == id));
        }
        return addedIps;
    }

    private List<AppRole> ResolveAppRole(long[] selectedIds)
    {
        List<AppRole> addedAppRoles = new();
        foreach(var id in selectedIds)
        {
            addedAppRoles.Add(ConnHandler.AppRoles.FirstOrDefault(x => x.Id == id));
        }
        return addedAppRoles;
    }

    private List<NetworkService> ResolveSvc(long[] selectedIds)
    {
        List<NetworkService> addedSvcs = new();
        foreach(var id in selectedIds)
        {
            addedSvcs.Add(ConnHandler.AvailableServices.FirstOrDefault(x => x.Id == id));
        }
        return addedSvcs;
    }

    private List<ServiceGroup> ResolveSvcGrp(long[] selectedIds)
    {
        List<ServiceGroup> addedSvcGrps = new();
        foreach(var id in selectedIds)
        {
            addedSvcGrps.Add(ConnHandler.AvailableServiceGroups.FirstOrDefault(x => x.Id == id));
        }
        return addedSvcGrps;
    }

    private string DisplayService(NetworkService service)
    {
        return FWO.Ui.Display.RuleDisplayBase.DisplayService(service, FWO.Report.Filter.ReportType.Rules).ToString();
    }

    private string DisplayServiceGroup(ServiceGroup grp)
    {
        if(grp.Name != null && grp.Name != "")
        {
            return grp.Name;
        }
        if(grp.NetworkServices.Count > 0)
        {
            return DisplayService(grp.NetworkServices[0].Content);
        }
        return "anything else";
    }

    private async Task DataInconsistent()
    {

    }

    private async Task WrapAsync(Func<Task> action)
    {
        await action();
        await ConnHandlerChanged.InvokeAsync(ConnHandler);
    }
}
