@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using System.Net
@using FWO.Ui.Auth
@using FWO.ApiClient
@using FWO.Middleware.Client
@using FWO.ApiConfig
@using FWO.Ui.Services
@using System.Security.Claims

@inject MiddlewareClient middlewareClient
@inject ProtectedSessionStorage sessionStorage
@inject AuthenticationStateProvider AuthService
@inject APIConnection ApiConnection
@inject UserConfig userConfig
@inject GlobalConfig globalConfig

@if (showLoginForm)
{
    <div class="row m-4 justify-content-center">
        <div>
            <h2 class="text-center"> Login </h2>
            <div class="shadow-sm card p-3" style="width: 250px;">
                <form class="d-flex flex-column">
                    <div class="form-group">
                        <input type="text" class="form-control @InputClass" id="UsernameInput" placeholder="Username" @bind="Username" @bind:event="oninput" @onkeypress="ClearInputClass" @ref="usernameInput">
                    </div>
                    <div class="form-group">
                        <input type="password" class="form-control @InputClass" id="PasswordInput" placeholder="Password" @bind="Password" @bind:event="oninput" @onkeypress="ClearInputClass">
                    </div>
                    @if (loginInProgress == false)
                    {
                        <button class="btn btn-block btn-primary" @onclick:preventDefault="true" @onclick="LoginSubmit"><div class="oi oi-account-login"></div></button>
                    }
                    else
                    {
                        <div class="spinner-border text-primary align-self-center" role="status"></div>
                    }
                    <label class="m-2">@errorMessage</label>
                </form>
            </div>
        </div>
    </div>
}



@code
{
    // dont immediately show login page because session storage is only available after render, so there might be a immediate redirect
    private bool showLoginForm = false;

    private bool loginInProgress = false;

    private string Username = "";
    private string Password = "";

    private string InputClass = "";

    private string errorMessage = "";

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    private ElementReference usernameInput;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // This might be a reconnect. Check if there is a jwt in session storage.
            ProtectedBrowserStorageResult<string> jwtLoadRequest = await sessionStorage.GetAsync<string>("jwt");

            if (jwtLoadRequest.Success) // reconnect
            {
                await CreateUserContext(jwtLoadRequest.Value);
            }

            else // no reconnect
            {
                showLoginForm = true;
                StateHasChanged();
                await focusInput();
            }
        }
    }

    private void ClearInputClass(KeyboardEventArgs e)
    {
        InputClass = "";
    }

    private async Task LoginSubmit()
    {
        if (loginInProgress == false)
        {
            loginInProgress = true;

            // There is no jwt in session storage. Get one from auth module.
            MiddlewareServerResponse apiAuthResponse = await middlewareClient.AuthenticateUser(Username, Password);

            if (apiAuthResponse.Status == HttpStatusCode.OK)
            {
                string jwt = apiAuthResponse.GetResult<string>("jwt");

                // Save it in session storage.
                await sessionStorage.SetAsync("jwt", jwt);

                // Add all user relevant information to the current session. Also used when reloading page.
                await CreateUserContext(jwt);

                loginInProgress = false;
            }
            else
            {
                // There was an error trying to authenticate the user. Probably invalid credentials
                errorMessage = apiAuthResponse.Error + " See log for details!";

                // Visualisize there was an error by making border of inputboxes red
                InputClass = "is-invalid";
                loginInProgress = false;
                await focusInput();
                StateHasChanged();
            }
        }
    }

    private async Task focusInput()
    {
        if (showLoginForm)
            await usernameInput.FocusAsync();
    }

    private async Task CreateUserContext(string jwt)
    {
        // Tell api connection to use jwt as authentication
        ApiConnection.SetAuthHeader(jwt);

        // Try to auth with jwt (validates it and creates user context on UI side).
        await ((AuthStateProvider)AuthService).AuthenticateUser(jwt, userConfig, ApiConnection);
    }
}
