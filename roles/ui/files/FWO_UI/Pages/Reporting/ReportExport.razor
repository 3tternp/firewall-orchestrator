@using System.Text
@using FWO.Report
@using FWO.ApiConfig

@inject APIConnection apiConnection
@inject UserConfig userConfig

<button class="btn btn-sm btn-dark" @onclick='() => { if (ReportToExport != null) { ShowExportDialog = true; } else { 
                                                      DisplayMessageInUi(null, "Export report", "No generated report to export. Please generate report first!", true); } }'>Export Report</button>

<PopUp Title="Export Report" Show="@ShowExportDialog">
    <Body>
        <div>
            <p>Export as...</p>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="reportExportPdf" @bind="ExportPdf">
                <label class="form-check-label" for="reportExportPdf">
                    PDF
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="reportExportHtml" @bind="ExportHtml">
                <label class="form-check-label" for="reportExportHtml">
                    HTML
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="reportExportCsv" @bind="ExportCsv">
                <label class="form-check-label" for="reportExportCsv">
                    CSV
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="reportExportJson" @bind="ExportJson">
                <label class="form-check-label" for="reportExportJson">
                    JSON
                </label>
            </div>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="reportExportArchive" @bind="ExportArchive">
            <label class="form-check-label" for="reportExportArchive">
                Archive
            </label>
        </div>
    </Body>
    <Footer>
        <button class="btn btn-sm btn-primary" @onclick="async () => { await Export(); ShowExportDialog = false; ShowExportDownloadDialog = true; }">Export</button>
        <button class="btn btn-sm btn-secondary" @onclick="() => ShowExportDialog = false">Cancel</button>
    </Footer>
</PopUp>

<PopUp Title="Export Report Download" Show="@ShowExportDownloadDialog">
    <Body>
        <div class="d-flex flex-column align">
            <label class="ml-1 mr-1" for="reportExportFilename">Name:</label>
            <input class="form-control-sm ml-1 mr-1 mb-1" id="reportExportFileName" @bind:event="oninput" @bind="reportExportFile.Name" />
            @if (reportExportFile?.Csv != null)
            {
                <a class="btn btn-sm btn-info m-1" href="data:application/octet-stream;base64,@(Convert.ToBase64String(Encoding.UTF8.GetBytes(reportExportFile.Csv)))"
                   target="_blank" download="@(reportExportFile.Name).@("csv")">Download CSV</a>
            }
            @if (reportExportFile?.Pdf != null)
            {
                <a class="btn btn-sm btn-info m-1" href="data:application/octet-stream;base64,@(reportExportFile.Pdf)"
                   target="_blank" download="@(reportExportFile.Name).@("pdf")">Download PDF</a>
            }
            @if (reportExportFile?.Html != null)
            {
                <a class="btn btn-sm btn-info m-1" href="data:application/octet-stream;base64,@(Convert.ToBase64String(Encoding.UTF8.GetBytes(reportExportFile.Html)))"
                   target="_blank" download="@(reportExportFile.Name).@("html")">Download HTML</a>
            }
            @if (reportExportFile?.Json != null && ExportJson)
            {
                <a class="btn btn-sm btn-info m-1" href="data:application/octet-stream;base64,@(Convert.ToBase64String(Encoding.UTF8.GetBytes(reportExportFile.Json)))"
                   target="_blank" download="@(reportExportFile.Name).@("json")">Download JSON</a>
            }
        </div>
    </Body>
    <Footer>
        <button class="btn btn-sm btn-danger" @onclick="() => ShowExportDownloadDialog = false">Close</button>
    </Footer>
</PopUp>

@code
{
    [CascadingParameter]
    Action<Exception, string, string, bool> DisplayMessageInUi { get; set; }

    [Parameter]
    public ReportBase ReportToExport { get; set; }

    private bool ExportPdf = false;
    private bool ExportJson = false;
    private bool ExportHtml = false;
    private bool ExportCsv = false;
    private bool ExportArchive = false;
    private ReportFile reportExportFile;

    private bool ShowExportDialog = false;
    private bool ShowExportDownloadDialog = false;

    private async Task Export()
    {
        if (ReportToExport != null)
        {
            await Task.Run(async () =>
            {
                try
                {
                    reportExportFile = new ReportFile { Name = "Report", OwnerId = userConfig.User.DbId };

                    if (ExportHtml)
                    {
                        reportExportFile.Html = ReportToExport.ExportToHtml();
                    }

                    if (ExportPdf)
                    {
                        reportExportFile.Pdf = Convert.ToBase64String(ReportToExport.ToPdf());
                    }

                    if (ExportCsv)
                    {
                        reportExportFile.Csv = ReportToExport.ExportToCsv();
                    }

                    // if archiving, json report has to be generated
                    if (ExportJson || ExportArchive)
                    {
                        reportExportFile.Json = ReportToExport.ExportToJson();
                    }

                    if (ExportArchive)
                    {
                        var queryVariables = new
                        {
                            report_name = reportExportFile.Name,
                            report_start_time = DateTime.Now, // TODO: Change to correct dates
                            report_end_time = DateTime.Now,
                            report_owner_id = reportExportFile.OwnerId,
                            report_csv = reportExportFile.Csv,
                            report_pdf = reportExportFile.Pdf,
                            report_html = reportExportFile.Html,
                            report_json = reportExportFile.Json,
                        };

                        await apiConnection.SendQueryAsync<object>(ReportQueries.addGeneratedReport, queryVariables);
                    }
                }
                catch (Exception exception)
                {
                    DisplayMessageInUi(exception, "Export report", "Unclassified error.", true);
                }
            });
        }
        else
        {
            DisplayMessageInUi(null, "Export report", "No generated report to export. Please generate report first!", true);
        }
    }
}
