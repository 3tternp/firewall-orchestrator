@using FWO.ApiConfig
@using FWO.Report
@using FWO.Ui.Display
@using FWO.Report.Filter
@using FWO.Report.Filter.Exceptions
@using System.Text 
@using FWO.Ui.Services
@using FWO.Ui.Data

@inject APIConnection Connection
@inject UserConfig userConfig

@page "/report"

<Sidebar Collapsible="true" Resizeable="true" InitialWidth="sidebarLeftWidth" PositionLeft="true" @bind-Width="sidebarLeftWidth">
    <div class="p-3">

        <h5 class="text-left">Select device(s)</h5>
        <button class="btn btn-sm btn-secondary" @onclick="() => { fullDeviceSelection(); }">@selectButtonText</button>
        <br><br>

        @foreach (Management management in managementsOverview)
        {
            @if (management != null)
            {
                <Collapse Title="@(management.Name)" StartToggled="false" Style="@("primary")">
                    @foreach (Device device in management.Devices)
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="device.Id" @bind="device.selected" />
                            <label class="form-check-label" for="@device.Id">
                                &nbsp;@device.Name
                            </label>
                        </div>
                    }
                </Collapse>
            }
        }
    </div>
</Sidebar>

<div style="margin-left: @($"{sidebarLeftWidth + 10}px"); margin-right: @($"{sidebarRightWidth + 10}px");">
    <form class="m-1 position-relative" @onsubmit="GenerateReport">
        <input style="position:relative; z-index:1; background-color:rgba(0,0,0,0);" translate="no" autocapitalize="off"
               class="form-control" spellcheck="false" placeholder="Filter" @oninput="TryFilter" @bind="filterInput" />
        <div style="left:0px; top:0px; color:rgba(0,0,0,0); user-select:none;" translate="no" autocapitalize="off"
             class="form-control position-absolute whitespace-div" spellcheck="false">
            <span>@filterFeedbackStart</span><span class="error-underline">@filterFeedbackError</span><span>@filterFeedbackEnd</span>
        </div>
    </form>

    <div class="btn-group mr-1 ml-1 mb-1">
        <button class="btn btn-sm btn-primary" @onclick="GenerateReport">Generate Report</button>
        <button class="btn btn-sm btn-dark" @onclick="() => { ShowExportDialog = true; }">Export Report</button>
        <button class="btn btn-sm btn-secondary" @onclick="() => { reportTemplateInEdit = new ReportTemplate { Filter = filterInput }; ShowSaveTemplateDialog = true; }">Save as Template</button>
    </div>

    <hr />

    <PopUp Title="No device(s) selected." Show="@ShowNoDeviceSelectedWarning">
        <Body>
            <div>
                <p>Please select at least one device in the left side-bar before generating a report.</p>
            </div>
        </Body>
        <Footer>
            <button class="btn btn-primary" @onclick="() => ShowNoDeviceSelectedWarning = false">OK</button>
        </Footer>        
    </PopUp>

    <PopUp Title="Export Report" Show="@ShowExportDialog">
        <Body>
            <div>
                <p>Export as...</p>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="radioReportExport" id="reportExportPdf" checked>
                    <label class="form-check-label" for="reportExportPdf">
                        PDF
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="radioReportExport" id="reportExportHtml">
                    <label class="form-check-label" for="reportExportHtml">
                        HTML
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="radioReportExport" id="reportExportCsv">
                    <label class="form-check-label" for="reportExportCsv">
                        CSV
                    </label>
                </div>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="flexCheckChecked" checked>
                <label class="form-check-label" for="flexCheckChecked">
                    Archive
                </label>
            </div>
        </Body>
        <Footer>
            <button class="btn btn-primary" @onclick="() => { }">Export</button>
            <button class="btn btn-secondary" @onclick="() => ShowExportDialog = false">Cancel</button>
        </Footer>
    </PopUp>

    <PopUp Large="true" Title="Report Template" Show="@(ShowEditTemplateDialog || ShowSaveTemplateDialog)">
        <Body>
            <div>
                <div class="form-group">
                    <label for="saveTemplateName">Name:</label>
                    <input id="saveTemplateName" type="text" class="form-control" @bind="reportTemplateInEdit.Name">
                </div>
                <div class="form-group">
                    <label for="saveTemplateComment">Comment:</label>
                    <textarea id="saveTemplateComment" class="form-control" @bind="reportTemplateInEdit.Comment" />
                </div>
                <div class="form-group">
                    <label for="saveTemplateFilterLineTextarea">Filter:</label>
                    <textarea id="saveTemplateFilterLineTextarea" class="form-control" @bind="reportTemplateInEdit.Filter" />
                </div>
            </div>
        </Body>
        <Footer>
            <button class="btn btn-primary" @onclick="async () => { if (ShowSaveTemplateDialog) await SaveTemplate(); else await EditTemplate(); }">Save</button>
            <button class="btn btn-secondary" @onclick="() => ShowEditTemplateDialog = ShowSaveTemplateDialog = false">Cancel</button>
        </Footer>
    </PopUp>

    <PopUp Title="Report Template" Show="@ShowDeleteTemplateDialog">
        <Body>
            <p>Do you really want to delete report template "@reportTemplateInEdit.Name" ?</p>
        </Body>
        <Footer>
            <button class="btn btn-danger" @onclick="DeleteTemplate">Delete</button>
            <button class="btn btn-secondary" @onclick="() => ShowDeleteTemplateDialog = false">Cancel</button>
        </Footer>
    </PopUp>

    <div class="mr-1 ml-1 mb-1 shadow">
        <Collapse Title="Templates" Style="@("primary")">
            <div class="card-body">
                <Table TableClass="table table-bordered table-sm table-responsive" TableItem="ReportTemplate" Items="reportTemplates">
                    <Column Title="Actions" TableItem="ReportTemplate">
                        <Template>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-success" @onclick="() => filterInput = context.Filter">Load</button>
                                <button class="btn btn-sm btn-warning" @onclick="() => { reportTemplateInEdit = context; ShowEditTemplateDialog = true; }">Edit</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => { reportTemplateInEdit = context; ShowDeleteTemplateDialog = true; }">Delete</button>
                            </div>
                        </Template>
                    </Column>
                    <Column Title="Name" TableItem="ReportTemplate" Field="x => x.Name" />
                    <Column Title="Comment" TableItem="ReportTemplate" Field="x => x.Comment" />
                    <Column Title="Creation Date" TableItem="ReportTemplate" Field="x => x.CreationDate" />
                    <Column Title="Filter" TableItem="ReportTemplate" Field="x => x.Filter" />
                </Table>
            </div>
        </Collapse>
    </div>

    <div class="card mr-1 ml-1 mb-1 shadow">
        <div class="card-body">

            <a class="btn btn-sm btn-info" href="data:application/octet-stream;base64,@(Convert.ToBase64String(Encoding.ASCII.GetBytes("test")))"
               target="_blank" download="@("test").@("txt")">Download</a>

            @if (query != null)
            {
                @switch (query.ReportType)
                {
                    case rulesReport:
                        @foreach (Management management in managementsReport)
                        {
                            <Collapse Title="@management.Name" Style="@("primary")" StartToggled="false">

                                @foreach (Device device in management.Devices)
                                {
                                    <Collapse Title="@device.Name" Style="@("secondary")" StartToggled="false">
                                        <Table SelectedItems="selectedItemsReportRuleTable"
                                            RowClickAction="tableItem => { if (!selectedItemsReportRuleTable.Remove(tableItem)) selectedItemsReportRuleTable.Add(tableItem); StateHasChanged(); }"
                                            style="font-size:small" TableClass="table table-bordered table-sm table-responsive" TableItem="Rule" Items="device.Rules" ShowSearchBar="true"
                                            PageSize="rulesPerPage" ColumnReorder="true" TableRowClass="@(rule => rule.SectionHeader != null ? "hide-all-but-second-child second-child-full-width" : "")">

                                            <Column TableItem="Rule" Title="Number" DefaultSortColumn="true" Field="@(rChange => rChange.OrderNumber)" Sortable="true" Filterable="true" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayNumber(device.Rules))
                                                </Template>
                                            </Column>
                                            <Column TableItem="Rule" Title="Name" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true" />
                                            <Column TableItem="Rule" Title="Source Zone" Field="@(rChange => rChange.SourceZone)" Sortable="true" Filterable="true" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplaySourceZone())
                                                </Template>
                                            </Column>
                                            <Column TableItem="Rule" Title="Source" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplaySource())
                                                </Template>
                                            </Column>
                                            <Column TableItem="Rule" Title="Destination Zone" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayDestinationZone())
                                                </Template>
                                            </Column>
                                            <Column TableItem="Rule" Title="Destination" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayDestination())
                                                </Template>
                                            </Column>
                                            <Column TableItem="Rule" Title="Services" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayService())
                                                </Template>
                                            </Column>
                                            <Column TableItem="Rule" Title="Action" Field="@(rChange => rChange.Action)" Sortable="true" Filterable="true" Hideable="true" />
                                            <Column TableItem="Rule" Title="Track" Field="@(rChange => rChange.Track)" Sortable="true" Filterable="true" Hideable="true" />
                                            <Column TableItem="Rule" Title="Disabled" Field="@(rChange => rChange.Disabled)" Sortable="true" Filterable="true" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayDisabled())
                                                </Template>
                                            </Column>
                                            <Column TableItem="Rule" Title="UID" Field="@(rChange => rChange.Uid)" Sortable="true" Filterable="true" Hideable="true" />
                                            <Column TableItem="Rule" Title="Comment" Field="@(rChange => rChange.Comment)" Sortable="true" Filterable="true" Hideable="true" />

                                            <DetailTemplate TableItem="Rule">
                                                <div>test</div>
                                            </DetailTemplate>

                                            <Pager ShowPageNumber="true" ShowTotalCount="true" />
                                        </Table>
                                    </Collapse>
                                }
                            </Collapse>
                        }
                        break;

                    case changesReport:
                        @foreach (Management management in managementsReport)
                        {
                            <Collapse Title="@management.Name" Style="@("primary")" StartToggled="false">

                                @foreach (Device device in management.Devices)
                                {
                                    <Collapse Title="@device.Name" Style="@("secondary")" StartToggled="false">

                                        <Table SelectedItems="selectedItemsReportChangeTable"
                                            RowClickAction="tableItem => { if (!selectedItemsReportChangeTable.Remove(tableItem)) selectedItemsReportChangeTable.Add(tableItem); StateHasChanged(); }"
                                            style="font-size:small" TableClass="table table-bordered table-sm table-responsive" TableItem="RuleChange" Items="device.RuleChanges" ShowSearchBar="true"
                                            PageSize="rulesPerPage" ColumnReorder="true">

                                            <Column TableItem="RuleChange" Title="Change Time" Field="@(rChange => rChange.ChangeImport.Time)" Sortable="true" Filterable="true" Hideable="true" />
                                            <Column TableItem="RuleChange" Title="Change Type" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayChangeAction())
                                                </Template>
                                            </Column>
                                            <Column TableItem="RuleChange" Title="Name" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayName())
                                                </Template>
                                            </Column>
                                            <Column TableItem="RuleChange" Title="Source Zone" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplaySourceZone())
                                                </Template>
                                            </Column>
                                            <Column TableItem="RuleChange" Title="Source" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplaySource())
                                                </Template>
                                            </Column>
                                            <Column TableItem="RuleChange" Title="Destination Zone" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayDestinationZone())
                                                </Template>
                                            </Column>
                                            <Column TableItem="RuleChange" Title="Destination" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayDestination())
                                                </Template>
                                            </Column>
                                            <Column TableItem="RuleChange" Title="Services" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayService())
                                                </Template>
                                            </Column>
                                            <Column TableItem="RuleChange" Title="Action" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayAction())
                                                </Template>
                                            </Column>
                                            <Column TableItem="RuleChange" Title="Track" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayTrack())
                                                </Template>
                                            </Column>
                                            <Column TableItem="RuleChange" Title="Disabled" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayDisabled())
                                                </Template>
                                            </Column>
                                            <Column TableItem="RuleChange" Title="UID" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayUid())
                                                </Template>
                                            </Column>
                                            <Column TableItem="RuleChange" Title="Comment" Hideable="true">
                                                <Template>
                                                    @((MarkupString)context.DisplayComment())
                                                </Template>
                                            </Column>

                                            <DetailTemplate TableItem="RuleChange">
                                                <div>test</div>
                                            </DetailTemplate>

                                            <Pager ShowPageNumber="true" ShowTotalCount="true" />
                                        </Table>
                                    </Collapse>
                                }
                            </Collapse>
                        }
                        break;

                    case statisticsReport:
                        @if (globalStats != null)
                        {
                            <h5>Gobal number of Objects</h5>
                            <Table style="font-size:small" TableClass="table table-bordered table-sm table-responsive" TableItem="Management" Items="new Management[] {globalStats}">
                                <Column TableItem="Management" Title="Network objects" Field="@(Management => Management.NetworkObjectStatistics.ObjectAggregate.ObjectCount)" />
                                <Column TableItem="Management" Title="Service objects" Field="@(Management => Management.ServiceObjectStatistics.ObjectAggregate.ObjectCount)" />
                                <Column TableItem="Management" Title="User objects" Field="@(Management => Management.UserObjectStatistics.ObjectAggregate.ObjectCount)" />
                                <Column TableItem="Management" Title="Rules" Field="@(Management => Management.RuleStatistics.ObjectAggregate.ObjectCount)" />
                            </Table>
                        }
                        @foreach (Management management in managementsReport)
                        {
                            <Collapse Title="@management.Name" Style="@("primary")" StartToggled="false">
                                <h6>Total number of Objects per Management</h6>
                                <Table style="font-size:small" TableClass="table table-bordered table-sm table-responsive" TableItem="Management" Items="new Management[] {management}">
                                    <Column TableItem="Management" Title="Network objects" Field="@(Management => Management.NetworkObjectStatistics.ObjectAggregate.ObjectCount)" />
                                    <Column TableItem="Management" Title="Service objects" Field="@(Management => Management.ServiceObjectStatistics.ObjectAggregate.ObjectCount)" />
                                    <Column TableItem="Management" Title="User objects" Field="@(Management => Management.UserObjectStatistics.ObjectAggregate.ObjectCount)" />
                                    <Column TableItem="Management" Title="Rules" Field="@(Management => Management.RuleStatistics.ObjectAggregate.ObjectCount)" />
                                </Table>

                                <h6>Number of Rules per Gateway</h6>
                                <Table style="font-size:small" TableClass="table table-bordered table-sm table-responsive" TableItem="Device" Items="management.Devices">
                                    <Column TableItem="Device" Title="Gateway" Field="@(Device => Device.Name)" />
                                    <Column TableItem="Device" Title="Number of Rules" Field="@(Device => Device.RuleStatistics.ObjectAggregate.ObjectCount)" />
                                </Table>
                            </Collapse>
                        }
                        break;

                    default:
                        break;
                }

            }

        </div>
    </div>
</div>

<Sidebar Collapsible="true" Resizeable="true" InitialWidth="sidebarRightWidth" PositionLeft="false" @bind-Width="sidebarRightWidth">
    <div class="p-3">
        <TabSet>
            <Tab Title="All">
                <div class="btn btn-secondary" @onclick="@(() => collapseSidebarAll.CollapseAll())">collapse all</div>
                <CascadingValue Value="collapseSidebarAll">
                    <ObjectGroup InputDataType="Management" Data="managementsAllObjects" NameExtractor="man => man.Name" NetworkObjectExtractor="man => man.Objects"
                                 NetworkServiceExtractor="man => man.Services" NetworkUserExtractor="man => man.Users" />
                </CascadingValue>
            </Tab>
            <Tab Title="Report">
                <div class="btn btn-secondary" @onclick="@(() => collapseSidebarReport.CollapseAll())">collapse all</div>
                <CascadingValue Value="collapseSidebarReport">
                    <ObjectGroup InputDataType="Management" Data="managementsAllObjects" NameExtractor="man => man.Name" NetworkObjectExtractor="man => man.Objects"
                                 NetworkServiceExtractor="man => man.Services" NetworkUserExtractor="man => man.Users" />
                    <ObjectGroup InputDataType="Management" Data="managementsReport" NameExtractor="man => man.Name" NetworkObjectExtractor="man => man.Objects"
                                 NetworkServiceExtractor="man => man.Services" NetworkUserExtractor="man => man.Users" />
                </CascadingValue>
            </Tab>
            <Tab Title="Rule">
                <div class="btn btn-secondary" @onclick="@(() => collapseSidebarRule.CollapseAll())">collapse all</div>
                <CascadingValue Value="collapseSidebarRule">
                    <ObjectGroup InputDataType="Rule" Data="selectedItemsReportRuleTable" NameExtractor="rule => rule.Name"
                                 NetworkObjectExtractor="rule => Array.ConvertAll(rule.Tos.Concat(rule.Froms).ToArray(), location => location.Object)"
                                 NetworkServiceExtractor="rule => Array.ConvertAll(rule.Services, wrapper => wrapper.Content)"
                                 NetworkUserExtractor="rule => Array.FindAll(Array.ConvertAll(rule.Tos.Concat(rule.Froms).ToArray(), location => location.User), user => user != null)" />
                </CascadingValue>
            </Tab>
        </TabSet>
    </div>
</Sidebar>

@code
{
    [CascadingParameter]
    Action<Exception,string,string,bool> DisplayMessageInUi { get; set; }

    private const string deviceFilterStart = "(gateway=";
    private List<Rule> selectedItemsReportRuleTable = new List<Rule>();
    private List<RuleChange> selectedItemsReportChangeTable = new List<RuleChange>();

    private Management[] managementsOverview = new Management[0];
    private Management[] managementsReport = new Management[0];
    private Management[] managementsAllObjects = new Management[0];
    private Management[] managementsWithRelevantImportId = new Management[0];
    private Management globalStats = null;

    // private Dictionary<int,bool> deviceSelected = new Dictionary<int,bool>();

    private List<ReportTemplate> reportTemplates = new List<ReportTemplate>();
    private ReportFile[] archivedReports = new ReportFile[0];
    private ScheduledReport[] scheduledReports = new ScheduledReport[0];

    private int rulesPerFetch = 100;    // todo: rename to "elementsPerFetch" to cover all types of report/objects
    private int rulesPerPage = 0;   // todo: remove - no pagination implemented?

    private bool ShowNoDeviceSelectedWarning = false;
    private bool ShowExportDialog = false;
    private bool ShowSaveTemplateDialog = false;
    private bool ShowEditTemplateDialog = false;
    private bool ShowDeleteTemplateDialog = false;
    private bool ShowDeleteReportFileDialog = false;
    private bool ShowEditScheduledReportDialog = false;
    private bool ShowDeleteScheduledReportDialog = false;

    private int sidebarLeftWidth = 300;
    private int sidebarRightWidth = 300;

    private ReportTemplate reportTemplateInEdit = null;

    private int reportFileId = 0;

    private int scheduledReportId = 0;
    private string scheduledReportName = "";
    private string scheduledReportRepeatInterval = "";
    private int scheduledReportRepeatCount = 0;
    private string scheduledReportTemplateName = "";
    private string scheduledReportOwner = "";
    private string scheduledReportOutputFormat = "";
    private bool scheduledReportActive = false;

    private string filterFeedbackStart = "";
    private string filterFeedbackError = "";
    private string filterFeedbackEnd = "";
    private string filterInput = "";
    private const string rulesReportDefaultFilterLine = "type=rules and time=now ";
    //private string changesReportDefaultFilterLine = "type=changes and time=\"last year\" ";
    private const string changesReportDefaultFilterLine = "type=changes and time=\"this year\" ";
    private const string statisticsReportDefaultFilterLine = "type=statistics and time=now ";
    private const string anyObjcomplianceReportDefaultFilterLine = "type=compliance and time=now and (src=any or dst=any or svc=any or src=all or dst=all or svc=all) and not(action=drop or action=reject or action=deny)";
    private const string cleanupRulecomplianceReportDefaultFilterLine = "type=compliance and time=now and (src=any and dst=any and svc=any) or (src=all and dst=all and svc=all) and (action=drop or action=reject or action=deny)";
    private const string inactiveRulescomplianceReportDefaultFilterLine = "type=compliance and time=now and active=false";
    private const string complianceReportDefaultFilterLine = anyObjcomplianceReportDefaultFilterLine;
    private string reportGenerationTimeLine = "";
    private const string rulesReport = "rules";
    private const string changesReport = "changes";
    private const string complianceReport = "compliance";
    private const string statisticsReport = "statistics";
    private CollapseState collapseSidebarAll = new CollapseState();
    private CollapseState collapseSidebarReport = new CollapseState();
    private CollapseState collapseSidebarRule = new CollapseState();
    private DynGraphqlQuery query = null;
    private bool fullDeviceSelectionState = false;
    private string selectButtonText = "Select all devices";

    protected override void OnInitialized()
    {
        Task.Run(async () =>
        {
            try
            {
                GetSettings();
                PaginationVariables paginationVariables = new PaginationVariables() { Limit = rulesPerFetch, Offset = 0 };

                managementsAllObjects = await Connection.SendQueryAsync<Management[]>(ObjectQueries.getAllObjectDetails, paginationVariables);
                await InvokeAsync(StateHasChanged);

                bool newObjects = true;

                // lazy fetch all objects for right sidebar
                while (newObjects)
                {
                    paginationVariables.Offset += rulesPerFetch;
                    Management[] managementsCurrentFetch = await Connection.SendQueryAsync<Management[]>(ObjectQueries.getAllObjectDetails, paginationVariables);
                    newObjects = managementsAllObjects.Merge(managementsCurrentFetch);

                    await InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception exception)
            {
                DisplayMessageInUi(exception, "Object Fetch", "Error while fetching objects from API", true);
            }
        });

        Task.Run(async () =>
        {
            managementsOverview = await Connection.SendQueryAsync<Management[]>(DeviceQueries.getDevicesByManagements);
            await InvokeAsync(StateHasChanged);
        });

        Task.Run(async () =>
        {
            try
            {
                reportTemplates = (await Connection.SendQueryAsync<ReportTemplate[]>(ReportQueries.getReportTemplates)).ToList();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception exception)
            {
                DisplayMessageInUi(exception, "Report Template Fetch", "Error while fetching report templates from API", true);
            }
        });
    }

    private async Task GenerateReport()
    {
        try
        {
            query = Compiler.Compile(filterInput);
            if (isAnyDeviceFilterSet()) // remove all existing device filters first before adding new ones
                filterInput = replaceDeviceFilter(filterInput);
            else 
                filterInput = removeDeviceFilterPart(filterInput);
            if (!isAnyDeviceFilterSet())            // display pop-up with warning, todo: check if device is selected in filter line
            {
                ShowNoDeviceSelectedWarning = true;
                StateHasChanged();
                return;
            }
            query = Compiler.Compile(filterInput);  // recompile after reading device filter
            DateTime startTime = DateTime.Now;
            managementsReport = new Management[0]; // reset management data when switching between reports
            switch (query.ReportType)
            {
                case rulesReport:
                    ReportRules reportRules = new ReportRules();
                    await reportRules.Generate(rulesPerFetch, filterInput, Connection,
                        managementsReportIntermediate =>
                        {
                            managementsReport = managementsReportIntermediate;
                            return InvokeAsync(StateHasChanged);
                        });
                    break;

                case changesReport:
                    ReportChanges reportChanges = new ReportChanges();
                    await reportChanges.Generate(rulesPerFetch, filterInput, Connection,
                        managementsReportIntermediate =>
                        {
                            managementsReport = managementsReportIntermediate;
                            return InvokeAsync(StateHasChanged);
                        });
                    break;

                case statisticsReport:
                    globalStats = new Management();
                    ReportStatistics reportStatistics = new ReportStatistics();
                    await reportStatistics.Generate(0, filterInput, Connection,
                        managementsReportIntermediate =>
                        {
                            managementsReport = managementsReportIntermediate;
                            return InvokeAsync(() =>
                            {
                                foreach (Management mgm in managementsReport)
                                {
                                    globalStats.RuleStatistics.ObjectAggregate.ObjectCount += mgm.RuleStatistics.ObjectAggregate.ObjectCount;
                                    globalStats.NetworkObjectStatistics.ObjectAggregate.ObjectCount += mgm.NetworkObjectStatistics.ObjectAggregate.ObjectCount;
                                    globalStats.ServiceObjectStatistics.ObjectAggregate.ObjectCount += mgm.ServiceObjectStatistics.ObjectAggregate.ObjectCount;
                                    globalStats.UserObjectStatistics.ObjectAggregate.ObjectCount += mgm.UserObjectStatistics.ObjectAggregate.ObjectCount;
                                }
                                StateHasChanged();
                            });
                        });
                    break;
            }
            reportGenerationTimeLine = $"generation time: {DateTime.Now - startTime}.";
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, "Report generation", "Unclassified error.", true);
        }
    }

    private bool isAnyDeviceFilterSet () 
    {
        bool firstFilterSet = false;
        bool filterLogic = false;

        foreach (Management management in managementsOverview)
        {
            if (management != null)
            {
                foreach (Device device in management.Devices)
                {
                    if (device != null)
                    {
                        if (!firstFilterSet)
                        {
                            firstFilterSet = true;
                            filterLogic = device.selected;
                        } 
                        else 
                        {
                            if (device.selected != filterLogic)
                                return true;
                        }
                    }
                }
            }
        }
        // check if filterline contains a device filter
        if (query.FullQuery.Contains("device: {dev_name : {_ilike:") || query.FullQuery.Contains("management: {mgm_name : {_ilike:"))
            return true;
        return false;
    }

    private void fullDeviceSelection ()
    {
        fullDeviceSelectionState = !fullDeviceSelectionState;
        if (fullDeviceSelectionState)
            selectButtonText = "Clear device selection";
        else
            selectButtonText = "Select all devices";

        foreach (Management management in managementsOverview)
        {
            if (management != null)
            {
                foreach (Device device in management.Devices)
                {
                    device.selected = fullDeviceSelectionState;
                }
            }
        }       
    }

    private string cleanFilter(string filter)
    {
        filter = filter.Trim();
        if (filter.StartsWith("and "))
            filter = filter.Remove(0,4);
        if (filter.EndsWith(" and"))
            filter = filter.Remove(filter.Length-4,4);
        if (filter.Contains("and and"))  // remove duplicate and
            filter = filter.Remove(filter.IndexOf("and and"), 4);
        return filter;
    }

    private string replaceDeviceFilter(string currentInputFilter)
    {
        // remove old device filter part from currentInputFilter and add the new device filter from management.devices
        string filter = removeDeviceFilterPart(currentInputFilter).TrimEnd() + deviceFilterToString();

        // if the filter line (without device filter) is empty, get rid of the leading "and" of the device filter
        return cleanFilter(filter); 
    }

    private string removeDeviceFilterPart(string filter)
    {
        // identify and remove device filter part from filter
        if (filter.Contains(deviceFilterStart))
        {
            int startPosition = filter.IndexOf(deviceFilterStart);
            int endPosition = filter.IndexOf(")", startPosition+deviceFilterStart.Length);
            if (startPosition != 1 && endPosition != -1)
                filter = filter.Remove(startPosition, endPosition-startPosition+1); // to remove the first 10 characters
        }
        return cleanFilter(filter); 
    }

    private String deviceFilterToString () 
    {
        string deviceFilter = "";
        if (isAnyDeviceFilterSet()) {
            deviceFilter = " and (";
            foreach (Management management in managementsOverview)
            {
                if (management != null)
                {
                    foreach (Device device in management.Devices)
                    {
                        if (device.selected) 
                        {
                            if (deviceFilter.Length>6)  // not the first selected device
                                deviceFilter += " or ";
                            deviceFilter += $"gateway=\"{device.Name}\"";
                        }
                    }
                }
            }
            if (deviceFilter.Length>6)  // any filter found at all?
                deviceFilter += ") ";
            else
                deviceFilter = "";
        }
        return deviceFilter;
        // return " and gateway=forti";
    }
    
    private async Task SaveTemplate()
    {
        try
        {
            reportTemplateInEdit.CreationDate = DateTime.Now;

            var queryVariables = new
            {
                reportTemplateName = reportTemplateInEdit.Name,
                reportFilterLine = reportTemplateInEdit.Filter,
                reportTemplateCreate = reportTemplateInEdit.CreationDate,
                reportTemplateComment = reportTemplateInEdit.Comment
            };

            reportTemplateInEdit.Id = (await Connection.SendQueryAsync<NewReturning>(ReportQueries.addReportTemplate, queryVariables)).ReturnIds[0].NewId;
            reportTemplates.Add(reportTemplateInEdit);

            ShowSaveTemplateDialog = false;
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, "Save report template", "Unclassified error.", true);
        }
    }

    private async Task EditTemplate()
    {
        try
        {
            await Connection.SendQueryAsync<object>(ReportQueries.editReportTemplate, reportTemplateInEdit);
            reportTemplates[reportTemplates.FindIndex(reportTemplate => reportTemplate.Id == reportTemplateInEdit.Id)] = reportTemplateInEdit;

            ShowEditTemplateDialog = false;
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, "Edit report template", "Unclassified error.", true);
        }
    }

    private async Task DeleteTemplate()
    {
        try
        {
            var queryVariables = new
            {
                reportTemplateId = reportTemplateInEdit.Id
            };

            await Connection.SendQueryAsync<object>(ReportQueries.deleteReportTemplate, queryVariables);
            reportTemplates.Remove(reportTemplates.Find(reportTemplate => reportTemplate.Id == reportTemplateInEdit.Id));

            ShowDeleteTemplateDialog = false;
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, "Delete report template", "Unclassified error.", true);
        }
    }

    private void Export()
    {
        ReportRulesExporter exporter = new ReportRulesExporter() { Managements = managementsReport };
        string text = exporter.ToHtml();
        exporter.ToPdf();
    }

    private void TryFilter(ChangeEventArgs changeArgs)
    {
        DynGraphqlQuery query;

        try
        {
            filterInput = changeArgs.Value.ToString();

            query = Compiler.Compile(filterInput);

            filterFeedbackStart = filterInput;
            filterFeedbackError = "";
            filterFeedbackEnd = "";
        }
        catch (FilterException filterError)
        {
            int errorStart = filterError.ErrorPosition.Start.Value;
            int errorEnd = filterError.ErrorPosition.End.Value;

            // TODO: RESTRUCTURE (current structure only for debug purpose)
            filterFeedbackStart = $"{filterInput.Substring(0, errorStart)}";
            filterFeedbackError = filterInput.Substring(errorStart, errorEnd + 1 - errorStart);
            filterFeedbackEnd = $"{filterInput.Substring(errorEnd, filterInput.Length - 1 - errorEnd)}";
        }
        catch (Exception unexpectedError)
        {
#if DEBUG
            DisplayMessageInUi(unexpectedError, "Filter", "Unclassified error.", false);
#endif
        }
    }

    private void GetSettings()
    {
        try
        {
            string settingsValue = userConfig.GetConfigValue(ConfigDbAccess.kRulesPerFetch);
            if (settingsValue != "")
            {
                rulesPerFetch = Int32.Parse(settingsValue);
            }
        }
        catch (Exception exception)
        {
            Log.WriteError("Read Config", $"Error reading config value", exception);
        }
    }
}
