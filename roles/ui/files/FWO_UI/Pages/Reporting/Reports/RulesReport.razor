@using FWO.Ui.Display

@foreach (Management management in Managements)
{
    @if (management.Devices.Where(device => device.Rules != null && device.Rules.Count() > 0).Count() > 0)
    {
        <Collapse Title="@management.Name" Style="@("primary")" StartToggled="false">

            @foreach (Device device in management.Devices)
            {
                @if (device.Rules.Length > 0)
                {
                    <Collapse Title="@device.Name" Style="@("secondary")" StartToggled="true">
                        <Table SelectedItems="SelectedRules"
                               RowClickAction="rule => { rule.DeviceName = device.Name; if (!SelectedRules.Remove(rule)) SelectedRules.Add(rule); StateHasChanged(); }"
                               style="font-size:small" TableClass="table table-bordered table-sm table-responsive" TableItem="Rule" Items="device.Rules" ShowSearchBar="true"
                               PageSize="RulesPerPage" ColumnReorder="true" TableRowClass="@(rule => rule.SectionHeader != null ? "hide-all-but-second-child second-child-full-width" : "")">

                            <Column TableItem="Rule" Title="Number" DefaultSortColumn="true" Field="@(rChange => rChange.OrderNumber)" Sortable="true" Filterable="true" Hideable="true">
                                <Template>
                                    @((MarkupString)context.DisplayNumber(device.Rules))
                                </Template>
                            </Column>
                            <Column TableItem="Rule" Title="Name" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true" />
                            <Column TableItem="Rule" Title="Source Zone" Field="@(rChange => rChange.SourceZone)" Sortable="true" Filterable="true" Hideable="true">
                                <Template>
                                    @((MarkupString)context.DisplaySourceZone())
                                </Template>
                            </Column>
                            <Column TableItem="Rule" Title="Source" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true">
                                <Template>
                                    @((MarkupString)context.DisplaySource())
                                </Template>
                            </Column>
                            <Column TableItem="Rule" Title="Destination Zone" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true">
                                <Template>
                                    @((MarkupString)context.DisplayDestinationZone())
                                </Template>
                            </Column>
                            <Column TableItem="Rule" Title="Destination" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true">
                                <Template>
                                    @((MarkupString)context.DisplayDestination())
                                </Template>
                            </Column>
                            <Column TableItem="Rule" Title="Services" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true">
                                <Template>
                                    @((MarkupString)context.DisplayService())
                                </Template>
                            </Column>
                            <Column TableItem="Rule" Title="Action" Field="@(rChange => rChange.Action)" Sortable="true" Filterable="true" Hideable="true" />
                            <Column TableItem="Rule" Title="Track" Field="@(rChange => rChange.Track)" Sortable="true" Filterable="true" Hideable="true" />
                            <Column TableItem="Rule" Title="Disabled" Field="@(rChange => rChange.Disabled)" Sortable="true" Filterable="true" Hideable="true">
                                <Template>
                                    @((MarkupString)context.DisplayDisabled())
                                </Template>
                            </Column>
                            <Column TableItem="Rule" Title="UID" Field="@(rChange => rChange.Uid)" Sortable="true" Filterable="true" Hideable="true" />
                            <Column TableItem="Rule" Title="Comment" Field="@(rChange => rChange.Comment)" Sortable="true" Filterable="true" Hideable="true" />

                            <DetailTemplate TableItem="Rule">
                                <div>test</div>
                            </DetailTemplate>

                            <CustomRow TableItem="Rule" IsActiveForItem="(rule => !String.IsNullOrEmpty(rule.SectionHeader))">
                                <td class="bg-light" colspan="13"><div class="font-weight-bold">@(context.SectionHeader)</div></td>
                            </CustomRow>

                            <Pager ShowPageNumber="true" ShowTotalCount="true" />
                        </Table>
                    </Collapse>
                }
            }
        </Collapse>
    }
}

@code
{
    [Parameter]
    public List<Rule> SelectedRules { get; set; }

    [Parameter]
    public int RulesPerPage { get; set; }

    [Parameter]
    public Management[] Managements { get; set; }
}
