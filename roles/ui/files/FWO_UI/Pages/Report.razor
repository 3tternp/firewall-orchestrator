@using BlazorTable
@using FWO.ApiClient
@using FWO.ApiClient.Queries
@using FWO.ApiConfig
@using FWO.Api.Data
@using FWO.Report 
@using FWO.Ui.Display
@using FWO.Report.Filter
@using FWO.Report.Filter.Exceptions
@using FWO.Ui.Services

@inject APIConnection Connection
@inject UserConfig userConfig

@page "/report"

<Sidebar Collapsible="true" Resizeable="true" InitialWidth="sidebarLeftWidth" PositionLeft="true" @bind-Width="sidebarLeftWidth">
    <div class="p-3">
        <h5 class="text-center">Report Type</h5>

        <div class="list-group small mt-3">
            <a class="list-group-item list-group-item-action @(reportType==rulesReport?$"active":$"")" @onclick="() => { filterInput = rulesReportDefaultFilterLine; reportType = rulesReport; }" href="report">@rulesReport</a>
            <a class="list-group-item list-group-item-action @(reportType==changesReport?$"active":$"")" @onclick="() => { filterInput = changesReportDefaultFilterLine; reportType = changesReport; }" href="report">Changes</a>
            <a class="list-group-item list-group-item-action" @onclick="() => { }" href="#">Compliance</a>
            @* <a class="list-group-item list-group-item-action" @onclick="() => { }" href="#">Statistics Global</a> *@
            <a class="list-group-item list-group-item-action  @(reportType==statisticsReport?$"active":$"")" @onclick="() => { filterInput = statisticsReportDefaultFilterLine; reportType = statisticsReport; }" href="report">Statistics</a>
        </div>

        <hr />

        <button class="btn btn-primary btn-sm" @onclick="GenerateReport">Generate Report</button>

        <hr />

        @foreach (Management management in managementsOverview)
        {
            @if (management != null)
            {
                <Collapse Title="@(management.Name)" StartToggled="false" Style="@("primary")">
                    @foreach (Device device in management.Devices)
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="@($"man{management.Id}dev{device.Id}")" value="">
                            <label class="form-check-label" for="@($"man{management.Id}dev{device.Id}")">
                                @(device.Name)
                            </label>
                        </div>
                    }
                </Collapse>
            }
        }
    </div>
</Sidebar>
<div style="margin-left: @($"{sidebarLeftWidth + 10}px"); margin-right: @($"{sidebarRightWidth + 10}px");">
    <h4 class="m-1">Reporting</h4>
    <button class="btn btn-secondary btn-sm m-1" @onclick="Export">Generate Pdf Export</button>
    <a href="downloads/test.pdf" target="_blank" download>Download Pdf Export</a>
    <button class="btn btn-danger btn-sm m-1" @onclick="() => ShowPopUp = true">Show Pop up</button>

    <PopUp Title="test" Show="@ShowPopUp">
        <Body>
            test
        </Body>
        <Footer>
            <button class="btn btn-sm btn-danger" @onclick="() => ShowPopUp = false">Close</button>
        </Footer>
    </PopUp>

    <div class="form-inline m-1">
        <div class="form-group mt-1 mb-1 mr-2">
            <label for="rulesPerDeviceHtml" class="mr-1">Load rules per fetch: </label>
            <input id="rulesPerDeviceHtml" type="number" class="form-control-sm" @bind="rulesPerFetch" />
        </div>
        <div class="form-group mt-1 mb-1">
            <label for="rulesPerPageHtml" class="mr-1">Show rules per page: </label>
            <input id="rulesPerPageHtml" type="number" class="form-control-sm" @bind="rulesPerPage" />
        </div>
        <div class="form-group mt-1 mb-1">
            <input id="generationTime" type="text" class="form-control-sm" @bind="reportGenerationTimeLine" />
        </div>
        
    </div>

    <form class="mr-1 ml-1 position-relative" @onsubmit="GenerateReport">
        <input style="position:relative; z-index:1; background-color:rgba(0,0,0,0);" translate="no" autocapitalize="off"
               class="form-control" spellcheck="false" placeholder="Filter" @oninput="TryFilter" @bind="filterInput" />
        <div style="left:0px; top:0px; color:rgba(0,0,0,0); user-select:none;" translate="no" autocapitalize="off"
             class="form-control position-absolute whitespace-div" spellcheck="false">
            <span>@filterFeedbackStart</span><span class="error-underline">@filterFeedbackError</span><span>@filterFeedbackEnd</span>
        </div>
    </form>

    <div class="card m-1 shadow">
        <div class="card-body">

            @switch (reportType) {
                case rulesReport:
                    @foreach (Management management in managementsReport)
                    {
                        <Collapse Title="@management.Name" Style="@("primary")" StartToggled="false">

                            @foreach (Device device in management.Devices)
                            {
                                <Collapse Title="@device.Name" Style="@("secondary")" StartToggled="false">
                                    <Table SelectedItems="selectedItemsReportRuleTable"
                                        RowClickAction="tableItem => { if (!selectedItemsReportRuleTable.Remove(tableItem)) selectedItemsReportRuleTable.Add(tableItem); StateHasChanged(); }"
                                        style="font-size:small" TableClass="table table-bordered table-sm table-responsive" TableItem="Rule" Items="device.Rules" ShowSearchBar="true"
                                        PageSize="rulesPerPage" ColumnReorder="true" TableRowClass="@(rule => rule.SectionHeader != null ? "hide-all-but-second-child second-child-full-width" : "")">

                                        <Column TableItem="Rule" Title="Number" DefaultSortColumn="true" Field="@(rChange => rChange.OrderNumber)" Sortable="true" Filterable="true" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayNumber(device.Rules))
                                            </Template>
                                        </Column>
                                        <Column TableItem="Rule" Title="Name" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true" />
                                        <Column TableItem="Rule" Title="Source Zone" Field="@(rChange => rChange.SourceZone)" Sortable="true" Filterable="true" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplaySourceZone())
                                            </Template>
                                        </Column>
                                        <Column TableItem="Rule" Title="Source" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplaySource())
                                            </Template>
                                        </Column>
                                        <Column TableItem="Rule" Title="Destination Zone" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayDestinationZone())
                                            </Template>
                                        </Column>
                                        <Column TableItem="Rule" Title="Destination" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayDestination())
                                            </Template>
                                        </Column>
                                        <Column TableItem="Rule" Title="Services" Field="@(rChange => rChange.Name)" Sortable="true" Filterable="true" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayService())
                                            </Template>
                                        </Column>
                                        <Column TableItem="Rule" Title="Action" Field="@(rChange => rChange.Action)" Sortable="true" Filterable="true" Hideable="true" />
                                        <Column TableItem="Rule" Title="Track" Field="@(rChange => rChange.Track)" Sortable="true" Filterable="true" Hideable="true" />
                                        <Column TableItem="Rule" Title="Disabled" Field="@(rChange => rChange.Disabled)" Sortable="true" Filterable="true" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayDisabled())
                                            </Template>
                                        </Column>
                                        <Column TableItem="Rule" Title="UID" Field="@(rChange => rChange.Uid)" Sortable="true" Filterable="true" Hideable="true" />
                                        <Column TableItem="Rule" Title="Comment" Field="@(rChange => rChange.Comment)" Sortable="true" Filterable="true" Hideable="true" />

                                        <DetailTemplate TableItem="Rule">
                                            <div>test</div>
                                        </DetailTemplate>

                                        <Pager ShowPageNumber="true" ShowTotalCount="true" />
                                    </Table>
                                </Collapse>
                            }
                       </Collapse>
                    }
                    break;

                case changesReport:
                    @foreach (Management management in managementsReport)
                    {
                        <Collapse Title="@management.Name" Style="@("primary")" StartToggled="false">

                            @foreach (Device device in management.Devices)
                            {
                                <Collapse Title="@device.Name" Style="@("secondary")" StartToggled="false">

                                    <Table SelectedItems="selectedItemsReportChangeTable"
                                        RowClickAction="tableItem => { if (!selectedItemsReportChangeTable.Remove(tableItem)) selectedItemsReportChangeTable.Add(tableItem); StateHasChanged(); }"
                                        style="font-size:small" TableClass="table table-bordered table-sm table-responsive" TableItem="RuleChange" Items="device.RuleChanges" ShowSearchBar="true"
                                        PageSize="rulesPerPage" ColumnReorder="true">

                                        <Column TableItem="RuleChange" Title="Change Time" Field="@(rChange => rChange.ChangeImport.Time)" Sortable="true" Filterable="true" Hideable="true" />
                                        <Column TableItem="RuleChange" Title="Change Type" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayChangeAction())
                                            </Template>
                                        </Column>
                                        <Column TableItem="RuleChange" Title="Name" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayName())
                                            </Template>
                                        </Column>
                                        <Column TableItem="RuleChange" Title="Source Zone" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplaySourceZone())
                                            </Template>
                                        </Column>
                                        <Column TableItem="RuleChange" Title="Source" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplaySource())
                                            </Template>
                                        </Column>
                                        <Column TableItem="RuleChange" Title="Destination Zone" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayDestinationZone())
                                            </Template>
                                        </Column>
                                        <Column TableItem="RuleChange" Title="Destination" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayDestination())
                                            </Template>
                                        </Column>
                                        <Column TableItem="RuleChange" Title="Services" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayService())
                                            </Template>
                                        </Column>
                                        <Column TableItem="RuleChange" Title="Action" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayAction())
                                            </Template>
                                        </Column>
                                        <Column TableItem="RuleChange" Title="Track" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayTrack())
                                            </Template>
                                        </Column>
                                        <Column TableItem="RuleChange" Title="Disabled" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayDisabled())
                                            </Template>
                                        </Column>
                                        <Column TableItem="RuleChange" Title="UID" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayUid())
                                            </Template>
                                        </Column>
                                        <Column TableItem="RuleChange" Title="Comment" Hideable="true">
                                            <Template>
                                                @((MarkupString)context.DisplayComment())
                                            </Template>
                                        </Column>

                                        <DetailTemplate TableItem="RuleChange">
                                            <div>test</div>
                                        </DetailTemplate>

                                        <Pager ShowPageNumber="true" ShowTotalCount="true" />
                                    </Table>
                                </Collapse>
                            }
                       </Collapse>
                    }                
                    break;
                
                case statisticsReport:                            
                    @foreach (Management management in managementsReport)
                    {
                        <Collapse Title="@management.Name" Style="@("primary")" StartToggled="false">
                            <h6>Total number of objects per Management</h6>
                            <Table style="font-size:small" TableClass="table table-bordered table-sm table-responsive" TableItem="Management" Items="new Management[] {management}">
                                <Column TableItem="Management" Title="Network objects" Field="@(Management => Management.NetworkObjectStatistics.ObjectAggregate.ObjectCount)" />
                                <Column TableItem="Management" Title="Service objects" Field="@(Management => Management.ServiceObjectStatistics.ObjectAggregate.ObjectCount)" />
                                <Column TableItem="Management" Title="User objects" Field="@(Management => Management.UserObjectStatistics.ObjectAggregate.ObjectCount)" />
                                <Column TableItem="Management" Title="Rules" Field="@(Management => Management.RuleStatistics.ObjectAggregate.ObjectCount)" />
                            </Table>

                            <h6>Number of Rules per Gateway</h6>
                            <Table style="font-size:small" TableClass="table table-bordered table-sm table-responsive" TableItem="Device" Items="management.Devices">
                                <Column TableItem="Device" Title="Gateway" Field="@(Device => Device.Name)" />
                                <Column TableItem="Device" Title="Number of Rules" Field="@(Device => Device.RuleStatistics.ObjectAggregate.ObjectCount)" />
                            </Table>
                            
                       </Collapse>
                    }               
                    break;
                
                default:
                    break;
            }
        </div>
    </div>
</div>

<Sidebar Collapsible="true" Resizeable="true" InitialWidth="sidebarRightWidth" PositionLeft="false" @bind-Width="sidebarRightWidth">
    <div class="p-3">
        <TabSet>
            <Tab Title="All">
                <ObjectGroup InputDataType="Management" Data="managementsAllObjects" NameExtractor="man => man.Name" NetworkObjectExtractor="man => man.Objects"
                             NetworkServiceExtractor="man => man.Services" NetworkUserExtractor="man => man.Users" />
            </Tab>
            <Tab Title="Report">
                <ObjectGroup InputDataType="Management" Data="managementsReport" NameExtractor="man => man.Name" NetworkObjectExtractor="man => man.Objects"
                             NetworkServiceExtractor="man => man.Services" NetworkUserExtractor="man => man.Users" />
            </Tab>
            <Tab Title="Rule">
                <ObjectGroup InputDataType="Rule" Data="selectedItemsReportRuleTable" NameExtractor="rule => rule.Name"
                             NetworkObjectExtractor="rule => Array.ConvertAll(rule.Tos.Concat(rule.Froms).ToArray(), location => location.Object)"
                             NetworkServiceExtractor="rule => Array.ConvertAll(rule.Services, wrapper => wrapper.Content)"
                             NetworkUserExtractor="rule => Array.FindAll(Array.ConvertAll(rule.Tos.Concat(rule.Froms).ToArray(), location => location.User), user => user != null)" />
            </Tab>
        </TabSet>
    </div>
</Sidebar>

@code
{
    private List<Rule> selectedItemsReportRuleTable = new List<Rule>();
    private List<RuleChange> selectedItemsReportChangeTable = new List<RuleChange>();

    private Management[] managementsOverview = new Management[0];
    private Management[] managementsReport = new Management[0];
    private Management[] managementsAllObjects = new Management[0];
    private Management[] managementsWithRelevantImportId = new Management[0];
    
    private Management[] dummyManagementsArray = new Management[1]; 
    private int rulesPerFetch = 100;    // todo: rename to "elementsPerFetch" to cover all types of report/objects
    private int rulesPerPage = 0;   // todo: remove - no pagination implemented?

    private bool ShowPopUp = false;

    private int sidebarLeftWidth = 300;
    private int sidebarRightWidth = 300;

    private string filterFeedbackStart = "";
    private string filterFeedbackError = "";
    private string filterFeedbackEnd = "";
    private string filterInput = "";
    private string rulesReportDefaultFilterLine = "type=rules and time=now ";
    //private string changesReportDefaultFilterLine = "type=changes and time=\"last year\" ";
    private string changesReportDefaultFilterLine = "type=changes and time=\"this year\" ";
    private string statisticsReportDefaultFilterLine = "type=statistics and time=now ";
    
    private string reportGenerationTimeLine = "";
    private const string rulesReport = "Rules";
    private const string changesReport = "Changes";
    private const string complianceReport = "Compliance";
    private const string statisticsReport = "Statistics";
    private string reportType = rulesReport;


    [CascadingParameter]
    Action<string, string> ShowError { get; set; }

    protected override void OnInitialized()
    {
        Task.Run(async () =>
        {
            try
            {
                GetSettings();
                PaginationVariables paginationVariables = new PaginationVariables() { Limit = rulesPerFetch, Offset = 0 };
 
                managementsAllObjects = await Connection.SendQueryAsync<Management[]>(ObjectQueries.getAllObjectDetails, paginationVariables);
                await InvokeAsync(StateHasChanged);

                bool newObjects = true;

                // lazy fetch all objects for right sidebar
                while (newObjects)
                {
                    paginationVariables.Offset += rulesPerFetch;
                    Management[] managementsCurrentFetch = await Connection.SendQueryAsync<Management[]>(ObjectQueries.getAllObjectDetails, paginationVariables);
                    newObjects = managementsAllObjects.Merge(managementsCurrentFetch);

                    await InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception exception)
            {
                Log.WriteError("Object Fetching Error", "Error while fetching objects from API.", exception);
                ShowError("Object Fetching Error", "Error while fetching objects from API.");
            }
        });

        Task.Run(async () =>
        {
            managementsOverview = await Connection.SendQueryAsync<Management[]>(FWO.ApiClient.Queries.DeviceQueries.getDevicesByManagements);
            await InvokeAsync(StateHasChanged);
        });
    }

    private void GenerateReport()
    {
        try
        {
            Task.Run(() =>
            {
                DateTime startTime = DateTime.Now;

                switch (reportType) {
                    case rulesReport:
                        ReportRules reportRules = new ReportRules();
                        reportRules.Generate(rulesPerFetch, filterInput, Connection,
                            managementsReportIntermediate =>
                            {
                                managementsReport = managementsReportIntermediate;
                                return InvokeAsync(StateHasChanged);
                            });
                        break;
                        
                    case changesReport:
                        ReportChanges reportChanges = new ReportChanges();
                        reportChanges.Generate(rulesPerFetch, filterInput, Connection,
                            managementsReportIntermediate =>
                            {
                                managementsReport = managementsReportIntermediate;
                                return InvokeAsync(StateHasChanged);
                            });
                        break;
                case statisticsReport:
                        ReportStatistics reportStatistics = new ReportStatistics();
                        reportStatistics.Generate(0, filterInput, Connection,
                            managementsReportIntermediate =>
                            {
                                managementsReport = managementsReportIntermediate;
                                return InvokeAsync(StateHasChanged);
                            });
                        break;
                }
                reportGenerationTimeLine = $"generation time: {DateTime.Now - startTime}.";
            });
        }
        catch (Exception exception)
        {
            //this is the default error message when user's access rights are not sufficient (e.g. user = anonymous)
            //leave managementsReport as default = empty array
            if (exception.Message == "no such type exists in the schema: 'cidr'")
            {
                Log.WriteError("Report generation", "User does not have sufficient access rights.", exception);
                ShowError("Report generation", "You dont have sufficient acces rights.");
            }
            else
            {
                Log.WriteError("Report generation", "Unclassified error.", exception);
                ShowError("Report generation", "Unclassified error.");
            }
        }
    }

    private void Export()
    {
        ReportRulesExporter exporter = new ReportRulesExporter() { Managements = managementsReport };
        string text = exporter.ToHtml();
        exporter.ToPdf();
    }

    private void TryFilter(ChangeEventArgs changeArgs)
    {
        DynGraphqlQuery query;

        try
        {
            filterInput = changeArgs.Value.ToString();

            query = Compiler.Compile(filterInput);

            filterFeedbackStart = filterInput;
            filterFeedbackError = "";
            filterFeedbackEnd = "";
        }
        catch (FilterException filterError)
        {
            int errorStart = filterError.ErrorPosition.Start.Value;
            int errorEnd = filterError.ErrorPosition.End.Value;

            // TODO: RESTRUCTURE (current structure only for debug purpose)
            filterFeedbackStart = $"{filterInput.Substring(0, errorStart)}";
            filterFeedbackError = filterInput.Substring(errorStart, errorEnd + 1 - errorStart);
            filterFeedbackEnd = $"{filterInput.Substring(errorEnd, filterInput.Length - 1 - errorEnd)}";
        }
        catch (Exception unexpectedError)
        {
#if DEBUG
            ShowError("Filter Error", $"{unexpectedError.Message}\n{unexpectedError.StackTrace}");
#endif
        }
    }

    private void GetSettings()
    {
        try
        {
            string settingsValue = userConfig.GetConfigValue(ConfigDbAccess.kRulesPerFetch);
            if (settingsValue != "")
            {
                rulesPerFetch = Int32.Parse(settingsValue);
            }
        }
        catch(Exception exception)
        {
            Log.WriteError("Read Config", $"Error reading config value", exception);
        }
    }
}
